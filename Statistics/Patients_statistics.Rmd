---
title: "Statistical Analysis"
author: "Elena Marochkina"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: yes
    toc_depth: 4
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

```

```{r libraries, set colors}
library(tidyverse)
library(readr)
library(dplyr)
library(tidyr)
library(flextable)
library(officer)
library(RColorBrewer)
library(broom)
library(tibble)
library(nortest)
library(survival)
library(survminer)
library(ggpubr)
library(lme4)   
library(lmerTest) 


# Custom theme for visualisations
theme_custom <- theme_minimal() +
  theme (
    plot.title = element_text(size = 14, hjust = 0.5),
    plot.subtitle = element_text(size = 12, hjust = 0.5),
    strip.text = element_text(size = 10),
    axis.text = element_text(size = 8),
    axis.title = element_text(size = 12),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 10),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"),
  )

# Palette for visualisations
color_palette <- c(brewer.pal(9, "Pastel1"), brewer.pal(8, "Pastel2"), brewer.pal(8, "Set3"))

```

```{r Descriptive Stat functions}
# Function to calculate 95% confidence interval for the mean
ci_95 <- function(x) {
  n <- sum(!is.na(x))
  if (n < 3) return("Н/П*")
  se <- sd(x, na.rm = TRUE) / sqrt(n)  # Standard Error
  mean_x <- mean(x, na.rm = TRUE)
  ci <- c(mean_x - 1.96 * se, mean_x + 1.96 * se)
  paste0(round(ci[1], 2), " - ", round(ci[2], 2))
}

# List of descriptive statistics
statistics <- list(
  `_Number of values` = ~as.character(sum(!is.na(.x))),
  `_No data` = ~as.character(sum(is.na(.x))),
  `_Mean` = ~ifelse(sum(!is.na(.x)) == 0, "NA", as.character(mean(.x, na.rm = TRUE) %>% round(2))),
  `_Median` = ~ifelse(sum(!is.na(.x)) == 0, "NA", as.character(median(.x, na.rm = TRUE) %>% round(2))),
  `_SD` = ~ifelse(sum(!is.na(.x)) < 3, "NA", as.character(sd(.x, na.rm = TRUE) %>% round(2))),
  `_Q1 - Q3` = ~ifelse(sum(!is.na(.x)) == 0, "NA", paste0(as.character(quantile(.x, 0.25, na.rm = TRUE) %>% round(2)), " - ", as.character(quantile(.x, 0.75, na.rm = TRUE) %>% round(2)))),
  `_IQR` = ~ifelse(sum(!is.na(.x)) == 0, "NA", as.character(IQR(.x, na.rm = TRUE) %>% round(2))),
  `_95% CI` = ~ci_95(.x),
  `_min` = ~ifelse(sum(!is.na(.x)) == 0, "NA", as.character(min(.x, na.rm = TRUE) %>% round(2))),
  `_max` = ~ifelse(sum(!is.na(.x)) == 0, "NA", as.character(max(.x, na.rm = TRUE) %>% round(2)))
)

```

``` {r Statictical hypothesis check}
perform_statistical_tests <- function(data, dependent_var, independent_var, variable_name) {
  result_table <- tibble(Variable = character(),
                         Performed_test = character(),
                         Result = character(),
                         Interpretation = character())
  
  # Format p-value helper function
  format_p_value <- function(p) {
    if (p < 0.0001) {
      return("< 0.0001")  # Very small p-values
    } else {
      return(formatC(p, format = "f", digits = 4))  # Standard decimal notation
    }
  }
  
  # Check the type of independent variable
  if (is.numeric(data[[independent_var]])) {
    # If independent variable is numeric
    if (length(data[[independent_var]][!is.na(data[[independent_var]])]) > 3) {
      ad_result <- nortest::ad.test(data[[independent_var]][!is.na(data[[independent_var]])])
      
      if (ad_result$p.value > 0.05) {
        # Normal distribution
        t_test_result <- t.test(data[[independent_var]] ~ as.factor(data[[dependent_var]]), data = data)
        result_table <- result_table %>%
          add_row(
            Variable = variable_name,
            Performed_test = "T-Test",
            Result = format_p_value(t_test_result$p.value),
            Interpretation = ifelse(t_test_result$p.value < 0.05, "Significant", "Not significant")
          )
      } else {
        # Not normally distributed
        if (length(unique(data[[dependent_var]])) == 2) {
          mw_test_result <- wilcox.test(data[[independent_var]] ~ as.factor(data[[dependent_var]]), data = data)
          result_table <- result_table %>%
            add_row(
              Variable = variable_name,
              Performed_test = "Mann-Whitney U Test",
              Result = format_p_value(mw_test_result$p.value),
              Interpretation = ifelse(mw_test_result$p.value < 0.05, "Significant", "Not significant")
            )
        } else {
          stop("Dependent variable must have exactly two levels for Mann-Whitney U Test.")
        }
      }
    } else {
      stop("Not enough data points for Anderson-Darling test.")
    }
    
  } else if (is.factor(data[[independent_var]]) || is.character(data[[independent_var]])) {
    # If independent variable is categorical
    data[[dependent_var]] <- as.factor(data[[dependent_var]])
    contingency_table <- table(data[[independent_var]], data[[dependent_var]])
    
    # Check for zero counts
    if (any(contingency_table == 0)) {
      # Remove rows and columns with all zeros
      contingency_table <- contingency_table[rowSums(contingency_table) > 0, colSums(contingency_table) > 0]
      
      # If the table is now empty, stop with a warning
      if (nrow(contingency_table) == 0 || ncol(contingency_table) == 0) {
        stop("Contingency table is empty after removing zero counts.")
      }
      
      # Optionally merge low-frequency categories into "Other"
      data[[independent_var]] <- as.character(data[[independent_var]])
      low_frequency <- rownames(contingency_table)[rowSums(contingency_table) <= 5]  # Adjust threshold as needed
      data[[independent_var]][data[[independent_var]] %in% low_frequency] <- "Other"
      
      # Recalculate the table
      contingency_table <- table(data[[independent_var]], data[[dependent_var]])
    }
    
    # Perform Chi-Square Test
    chi_square_result <- chisq.test(contingency_table, simulate.p.value = TRUE)
    result_table <- result_table %>%
      add_row(
        Variable = variable_name,
        Performed_test = "Chi-Squared Test",
        Result = format_p_value(chi_square_result$p.value),
        Interpretation = ifelse(chi_square_result$p.value < 0.05, "Significant", "Not significant")
      )
  } else {
    stop("Independent variable must be either numeric or categorical.")
  }
  
  if (nrow(result_table) == 0) {
    stop("No valid tests were performed. Check your data and variables.")
  }
  
  return(result_table)
}


```

``` {r Survival Analysis}
HR_assessment <- function(survival_time, event_status, predictors, data) {
  
  # Create the formula for the Cox model
  formula <- as.formula(paste("Surv(", survival_time, ", ", event_status, ") ~", paste(predictors, collapse = " + ")))
  
  # Fit the Cox model
  cox_model <- coxph(formula, data = data)
  
  # Extract hazard ratios and confidence intervals
  hr <- exp(coef(cox_model))  # Hazard ratios
  hr_ci <- exp(confint(cox_model))  # Confidence intervals
  
  # Extract p-values
  p_values <- summary(cox_model)$coefficients[, "Pr(>|z|)"]
  
  # Get the variable names corresponding to each coefficient
  variable_names <- names(coef(cox_model))
  
  # Format p-values helper function
  format_p_value <- function(p) {
    if (is.na(p)) {
      return("NA")  # Handle missing p-values
    } else if (p < 0.0001) {
      return("< 0.0001")  # Very small p-values
    } else {
      return(formatC(p, format = "f", digits = 4))  # Standard decimal notation
    }
  }
  
  # Create a tibble with hazard ratios, confidence intervals, and p-values
  hr_table <- tibble(
    Variable = variable_names,
    Hazard_Ratio = hr,
    Lower_CI = hr_ci[, 1],
    Upper_CI = hr_ci[, 2],
    p_value = sapply(p_values, format_p_value)  # Apply p-value formatting
  )
  
  # Return the hazard ratio table
  return(hr_table)
}

```

``` {r LOS Analysis}
analyze_predictor_LOS <- function(data, predictor, LOS, patient_id) {
  
  # Helper function to format p-values
  format_p_value <- function(p) {
    if (p < 0.0001) {
      return("< 0.0001")  # Very small p-values
    } else {
      return(formatC(p, format = "f", digits = 4))  # Standard decimal notation with 4 digits
    }
  }

  # Validate Inputs
  if (!(predictor %in% colnames(data))) {
    stop(paste("Error: Predictor column", predictor, "does not exist in the dataset."))
  }
  if (!(LOS %in% colnames(data))) {
    stop(paste("Error: LOS column", LOS, "does not exist in the dataset."))
  }
  if (!(patient_id %in% colnames(data))) {
    stop(paste("Error: Patient ID column", patient_id, "does not exist in the dataset."))
  }

  # Check if LOS is numeric
  if (!is.numeric(data[[LOS]])) {
    stop("Error: LOS column must be numeric.")
  }

  # Check predictor type
  if (is.numeric(data[[predictor]])) {
    # Numerical predictor: Fit a mixed-effects linear regression model
    model <- lmer(as.formula(paste(LOS, "~", predictor, "+ (1 |", patient_id, ")")), data = data)
    model_summary <- summary(model)

    # Extract fixed-effect estimate and p-value
    fixed_effects <- tibble(
      Variable = predictor,
      Performed_test = "Mixed-Effects Linear Model",
      Statistic = model_summary$coefficients[predictor, "Estimate"],
      P_value = format_p_value(model_summary$coefficients[predictor, "Pr(>|t|)"]),
      Interpretation = ifelse(model_summary$coefficients[predictor, "Pr(>|t|)"] < 0.05, "Significant", "Not Significant")
    )

  } else if (is.factor(data[[predictor]]) || is.character(data[[predictor]])) {
    # Categorical predictor: Fit a mixed-effects linear regression model
    data[[predictor]] <- as.factor(data[[predictor]])  # Ensure it's a factor
    model <- lmer(as.formula(paste(LOS, "~", predictor, "+ (1 |", patient_id, ")")), data = data)
    model_summary <- summary(model)

    # Extract fixed-effect estimates and p-values for all levels of the categorical predictor
    fixed_effects <- as.data.frame(model_summary$coefficients) %>%
      rownames_to_column("Term") %>%
      filter(Term != "(Intercept)") %>%
      mutate(
        Variable = predictor,
        Performed_test = "Mixed-Effects Linear Model",
        Statistic = Estimate,
        P_value = sapply(`Pr(>|t|)`, format_p_value),
        Interpretation = ifelse(`Pr(>|t|)` < 0.05, "Significant", "Not Significant")
      ) %>%
      select(Variable, Term, Performed_test, Statistic, P_value, Interpretation) %>%
      as_tibble()  # Convert to tibble
  } else {
    stop("Error: Predictor must be numeric, factor, or character.")
  }

  # Return the result table as a tibble
  return(fixed_effects)
}

```


# 1. Outcomes Data

## 1.1. Read Data

```{r read files}
patients <- read.csv("../data/raw/cleaned/PATIENTS_clean.csv", stringsAsFactors = TRUE) %>%
  mutate(across(c(SUBJECT_ID, EXPIRE_FLAG), as.factor)) %>%
  filter(AGE_AT_ADMISSION > 0)

# Create a vector of SUBJECT_IDs where age > 0
subject_ids_adults <- patients$SUBJECT_ID

# Read the ADMISSIONS dataset and filter using the SUBJECT_ID vector
admissions <- read.csv("../data/raw/cleaned/ADMISSIONS_clean.csv", stringsAsFactors = TRUE) %>%
  filter(SUBJECT_ID %in% subject_ids_adults) %>% # Filter for adult patients 
  mutate(across(c(SUBJECT_ID, HADM_ID), as.factor)) 

# Read the ICUSTAYS dataset and filter using the SUBJECT_ID vector
icu_stays <- read.csv("../data/raw/cleaned/ICUSTAYS_clean.csv", stringsAsFactors = TRUE) %>%
  filter(SUBJECT_ID %in% subject_ids_adults) %>%  # Filter for adult patients
  mutate(across(c(SUBJECT_ID, HADM_ID), as.factor)) 
```

## 1.2. Desriptive Statistics and Visualisation Analysis

### 1.2.1. Outcome 1: Death Status

```{r descriptive statistics for death status}
patients %>%
  select(EXPIRE_FLAG) %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "Value") %>%
  group_by(Variable, Value) %>%
  summarise(n = n(), .groups = 'drop') %>%
  group_by(Variable) %>%
  mutate(`No data` = sum(is.na(Value)),
         `% by group` = (n / sum(n)) * 100) %>%
  ungroup() %>%
  select(Variable, Value, n, `% by group`, `No data`) %>%
  arrange(Variable, Value) %>%
  flextable() %>%
  merge_v("Variable") %>%
  autofit() %>%
  border_inner(border = fp_border(color = "black", width = 1)) %>%
  border_outer(border = fp_border(color = "black", width = 1))
```

```{r barplot for death status}
# Visualization for EXPIRE_FLAG in patients dataset
ggplot(patients, aes(x = as.factor(EXPIRE_FLAG), fill = as.factor(EXPIRE_FLAG))) +
  geom_bar(color = "black") +
    geom_text(stat = "count", aes(label = after_stat(count)),
            size = 3, 
            fontface = "bold", 
            vjust = -0.5) +
  scale_fill_manual(values = sample(color_palette, size = length(unique(patients$EXPIRE_FLAG)), replace = FALSE), labels = c("0" = "Not Dead", "1" = "Dead")) +
  labs(title = "Distribution of Death Status", x = "Death Status", y = "Count", fill = "Death Status") +
  theme_custom

```

-   There were 30,761 patients who did not die (labeled "Not Dead").
-   There were 15,759 patients who died (labeled "Dead").

This indicates that a higher proportion of patients in the dataset survived compared to those who did not. The ratio of surviving patients to deceased patients is approximately 2:1, which suggests that while mortality is significant, more patients survived than passed away during the period considered.

### 1.2.2. Outcome 2: Length of Survival

```{r descriptive statistics for length of survival}
# Create admissions_outcome file whith unique SUBJECT_ID and summarise SURVIVAL
admissions_outcome <- admissions %>%
  select(SURVIVAL,SUBJECT_ID) %>%
  group_by(SUBJECT_ID) %>%
  summarise(
    SURVIVAL = sum(SURVIVAL, na.rm = TRUE)
  ) %>%
  ungroup()

admissions_outcome %>%
  select(SURVIVAL) %>%
  summarise(across(everything(), statistics)) %>%
  pivot_longer(cols = everything(), names_sep = "__", names_to = c("Variable", "Stat")) %>%
  rename(`Value` = value) %>%
  flextable() %>%
  merge_v("Variable") %>%
  width(j = c("Variable", "Stat", "Value"), width = 2) %>%
  autofit() %>%
  border_inner(border = fp_border(color = "black", width = 1)) %>%
  border_outer(border = fp_border(color = "black", width = 1))
```

**Outliers Check**

``` {r outliers check for length of survival}
# Calculate mean and standard deviation
mean_value <- mean(admissions_outcome$SURVIVAL, na.rm = TRUE)
sd_value <- sd(admissions_outcome$SURVIVAL, na.rm = TRUE)

# Define the 3-sigma range
lower_bound <- mean_value - 3 * sd_value
upper_bound <- mean_value + 3 * sd_value

# Identify outliers
outliers <- admissions_outcome %>%
  filter(SURVIVAL < lower_bound | SURVIVAL > upper_bound)

# Calculate the number and percentage of outliers
num_outliers <- nrow(outliers)
total_values <- nrow(admissions_outcome)
percent_outliers <- (num_outliers / total_values) * 100

# Print the number and percentage of outliers
cat("Number of outliers:", num_outliers, "\n")
cat("Percentage of outliers:", round(percent_outliers, 2), "%\n")

# Filter out the outliers
admissions_outcome <- admissions_outcome %>%
  filter(SURVIVAL >= lower_bound & SURVIVAL <= upper_bound)
```

Based on the small percentage of outliers observed, it was decided to filter them out. These outliers could potentially represent patients who were in a prolonged coma or had unusually extended hospital stays.

```{r boxplot for length of survival}
# Boxplot for TIMETODEATH
ggplot(admissions_outcome, aes(y = SURVIVAL)) +
  geom_boxplot(fill = color_palette[4], color = "black") +
  labs(title = "Boxplot of Time to Death (in Days)",
       y = "Time to Death (in days)") +
  theme_custom

```

```{r density plot for length of survival}
ggplot(admissions_outcome, aes(x = SURVIVAL)) +
  geom_density(fill = color_palette[14], alpha = 0.7) +
  labs(title = "Density Plot of Time to Death (in Days)",
       x = "Time to Death (in days)",
       y = "Density") +
  theme_custom
```

The boxplot and density plot show that most patients died within 0 to 30 days, with a median around 10 days. There are still several outliers, indicating some patients survived much longer, possibly due to unique conditions such as prolonged illness or coma.

### 1.2.3. Outcome 3: Length of ICU Stay

```{r descriptive statistics for length of ICU stay}

icu_stays %>%
  select(LOS) %>%
  summarise(across(everything(), statistics)) %>%
  pivot_longer(cols = everything(), names_sep = "__", names_to = c("Variable", "Stat")) %>%
  rename(`Value` = value) %>%
  flextable() %>%
  merge_v("Variable") %>%
  width(j = c("Variable", "Stat", "Value"), width = 2) %>%
  autofit() %>%
  border_inner(border = fp_border(color = "black", width = 1)) %>%
  border_outer(border = fp_border(color = "black", width = 1))
```

**Check for outliers**

```{r check for outliers for length of ICU stay}
# Calculate mean and standard deviation for LOS variable
mean_los <- mean(icu_stays$LOS, na.rm = TRUE)
sd_los <- sd(icu_stays$LOS, na.rm = TRUE)

# Identify outliers using the 3-sigma rule
icu_stays$outlier_los <- ifelse(
  icu_stays$LOS > (mean_los + 3 * sd_los) | icu_stays$LOS < (mean_los - 3 * sd_los),
  TRUE, 
  FALSE
)

# Count the number and percentage of outliers
num_outliers_los <- sum(icu_stays$outlier_los, na.rm = TRUE)
percent_outliers_los <- (num_outliers_los / nrow(icu_stays)) * 100

# Print results
cat("Number of outliers in LOS:", num_outliers_los, "\n")
cat("Percentage of outliers in LOS:", round(percent_outliers_los, 2), "%\n")

# Filter out the outliers
icu_stays_outcome <- icu_stays %>%
  select(LOS, SUBJECT_ID, HADM_ID, outlier_los) %>%
  filter(outlier_los == FALSE)

# Drop the outlier column after filtering
icu_stays$outlier_los <- NULL
```

Based on the relatively small percentage of outliers (1.95%), it was decided to filter them out from the icu_stays dataset. This filtering helps ensure a more robust analysis by excluding extreme cases that could disproportionately impact the results. It's worth noting that some of these outliers could represent unique cases, such as patients in a coma or those with extended ICU stays due to complex medical conditions.

```{r violin plot for length of ICU stay}
ggplot(icu_stays_outcome, aes(x = "", y = LOS)) +
  geom_violin(fill = color_palette[10], color = "black") +
  geom_boxplot(width = 0.1, fill = "white", outlier.shape = NA) +
  labs(title = "Violin Plot of Length of ICU Stay (LOS)",
       y = "Length of ICU Stay (Days)",
       x = "") +
  theme_minimal()

```

This plot highlights that most patients had shorter ICU stays, but there are a few cases with extended durations that could represent unique medical conditions or complications.

# 2. Patients Data

## 2.1. Read and Prepare Data

```{r read file patients}
patients <- patients %>%
  mutate(
    DOB = as.POSIXct(DOB, format = "%Y-%m-%d"),
    DOD = as.POSIXct(DOD, format = "%Y-%m-%d")
  ) %>%
  filter(SUBJECT_ID %in% subject_ids_adults) # Filter for adult patients 

skimr::skim(patients)
```

## 2.2. Desriptive Statistics

### 2.2.1. Descriptive Statistics for Numerical Variables (Patient data)

```{r descriptive statistics for numerical vars}
# Summarize the statistics for each numeric variable
patients %>%
  select(-ROW_ID, -SUBJECT_ID, -EXPIRE_FLAG) %>%
  select(where(is.numeric)) %>% 
  summarise(across(everything(), statistics)) %>%
  pivot_longer(cols = everything(), names_sep = "__", names_to = c("Variable", "Stat")) %>%
  rename(`Value` = value) %>%
  flextable() %>%
  merge_v("Variable") %>%
  width(j = c("Variable", "Stat", "Value"), width = 2) %>%
  autofit() %>%
  border_inner(border = fp_border(color = "black", width = 1)) %>%
  border_outer(border = fp_border(color = "black", width = 1))
```

### 2.2.2. Descriptive Statistics for Categorical Variables (Patient data)

```{r Descriptive statistics patients for categorical vars}
# Clean and summarize the categorical data for all factor variables
patients %>%
  select(-DOB, -DOD, -SUBJECT_ID) %>%
  select(where(is.factor)) %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "Value") %>%
  group_by(Variable, Value) %>%
  summarise(n = n(), .groups = 'drop') %>%
  group_by(Variable) %>%
  mutate(`No data` = sum(is.na(Value)),
         `% by group` = (n / sum(n)) * 100) %>%
  ungroup() %>%
  select(Variable, Value, n, `% by group`, `No data`) %>%
  arrange(Variable, Value) %>%
  flextable() %>%
  merge_v("Variable") %>%
  autofit() %>%
  border_inner(border = fp_border(color = "black", width = 1)) %>%
  border_outer(border = fp_border(color = "black", width = 1))
```

## 2.3. Visualisation Analysis by Outcome

### 2.3.1. Outcome 1: Death Status by Patients Data

```{r death status by gender}
ggplot(patients, aes(x = GENDER, fill = EXPIRE_FLAG)) +
  geom_bar(position = position_dodge2(width = 0.9), color = "black") +
  geom_text(stat = 'count', aes(label = after_stat(count)), position = position_dodge2(width = 0.9), vjust = -0.5) +
  scale_fill_manual(values = sample(color_palette, size = length(unique(patients$EXPIRE_FLAG)), replace = FALSE), labels = c("0" = "Not Dead", "1" = "Dead")) +
  labs(title = "Death Status by Gender", x = "Gender", y = "Count", fill = "Death Status") +
  theme_custom
```

-   Males (M) have a higher count in both survival (17,597) and death (8,524) categories compared to females.
-   Females (F) have a lower count, with 13,164 surviving and 7,235 deceased.

This suggests that while the total number of male patients is higher, the proportion of deceased individuals appears similar across genders.

```{r death status by age at admission}
ggplot(patients, aes(x = AGE_AT_ADMISSION, fill = EXPIRE_FLAG)) +
  geom_histogram(binwidth = 5, alpha = 0.7, position = "identity", color = "black") +
  scale_fill_manual(values = sample(color_palette, size = length(unique(patients$EXPIRE_FLAG))), labels = c("0" = "Not Dead", "1" = "Dead")) +
  labs(title = "Death Status by Age at Admission", 
       x = "Age at Admission", 
       y = "Count", 
       fill = "Death Status") +
  theme_custom

```

-   Increasing Death Rate with Age: The number of deaths increases as age at admission increases, particularly noticeable in older age groups (60+ years). This suggests a higher mortality rate with increasing age.
-   Peak in Midlife and Elderly: The number of admissions peaks around middle age (45–65) with a higher number of surviving patients but a noticeable increase in death cases as age progresses.

During the exploratory data analysis, a significant spike in admissions for newborns (age 0) was observed, with the vast majority of these infants being alive. After careful consideration, it was decided to exclude the data for newborns (age 0) from our analysis.

**Rationale for Removal:**
1. Different Health Dynamics in Newborns

Newborns (age 0) have distinct health characteristics and mortality patterns compared to older children and adults. Their admissions are often related to birth-related complications, immediate post-birth care, or congenital conditions. These factors may not be directly relevant to the survival analysis intended for the rest of the population.
The survival dynamics for newborns are very different from those for older children or adults, making it difficult to generalize survival factors across the age spectrum when newborns are included.

2. Survival Bias in Newborns

The vast majority of newborns survive, which introduces a potential survival bias into the analysis. Since survival outcomes for newborns are typically skewed toward "alive" (due to medical advances in neonatal care), their inclusion could dilute the significance of other age groups and make it harder to detect meaningful survival trends.
Including newborns could potentially lead to misleading conclusions about the effect of age on survival outcomes, as the survival rate for age 0 is much higher compared to other age groups, thus overshadowing the variability observed in older patients.
Distortion of Survival Model Results:

The presence of a large proportion of patients who survive (newborns) can distort the results of a survival analysis. If survival outcomes for newborns (age 0) are predominantly "alive," they can skew the overall survival curve, potentially masking or distorting the real relationship between age and survival in older populations.
By excluding newborns, we ensure that the survival analysis reflects more accurate and relevant survival patterns across the broader population, without the confounding effect of newborn health outcomes.

### 2.3.2. Outcome 2: Length of Survival by Patients Data

```{r length of survival by age and gender}
# Merge admissions with patients data to include AGE_AT_ADMISSION
admissions_patients <- admissions_outcome %>%
  left_join(patients, by = "SUBJECT_ID")

# Create a new age group column based on quintiles
age_breaks <- quantile(admissions_patients$AGE_AT_ADMISSION, probs = seq(0, 1, 0.2), na.rm = TRUE)
age_labels <- paste0("(", round(head(age_breaks, -1)), "-", round(tail(age_breaks, -1)), "]")

admissions_patients <- admissions_patients %>%
  mutate(AGE_QUINTILE = cut(AGE_AT_ADMISSION, 
                            breaks = age_breaks,
                            include.lowest = TRUE,
                            labels = age_labels))

# Plot including age quintiles as facets
ggplot(admissions_patients, aes(x = GENDER, y = SURVIVAL, fill = GENDER)) +
  geom_boxplot() +
  facet_wrap(~ AGE_QUINTILE, ncol = 3) +  # Facet by age quintiles
  labs(title = "Length of Survival by Gender and Age Quintile",
       x = "Gender",
       y = "Time to Death (Days)") +
  scale_fill_manual(values = sample(color_palette, size = length(unique(patients$EXPIRE_FLAG)))) +
  theme_custom

ggplot(admissions_patients, aes(x = SURVIVAL, y = as.factor(AGE_QUINTILE), fill = GENDER, color = GENDER)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.7) +
  geom_jitter(width = 0.2, alpha = 0.5) +
  facet_wrap(~GENDER, scales = "free_y") +
  theme_custom +
 scale_fill_manual(values = color_palette) +  # Color for boxplot fill
  scale_color_manual(values = color_palette) + # Color for jitter points
  labs(
    title = "Time to Death by Age Quintile for Males and Females",
    y = "Time to Death (Days)", x = "Age Quintile"
  ) +
  theme(
    legend.position = "none",
    strip.text = element_text(size = 12, face = "bold")
  )

```

The plot allows for the visualization of how gender and age interact to influence survival times. It suggests that older females tend to have longer survival times than older males, but there are significant outliers in each group. The presence of NA age values indicates patients whose age could not be determined.

### 2.3.3. Outcome 3: Length of ICU Stay by Patients Data

```{r length of ICU stay by gender and age}
# Merge icu_stays with patients data to include AGE_AT_ADMISSION
combined_data_los_patients <- icu_stays_outcome %>%
  left_join(patients, by = "SUBJECT_ID")

# Create a new age group column based on quintiles
age_breaks_los <- quantile(combined_data_los_patients$AGE_AT_ADMISSION, probs = seq(0, 1, 0.2), na.rm = TRUE)
age_labels_los <- paste0("(", round(head(age_breaks_los, -1)), "-", round(tail(age_breaks_los, -1)), "]")

combined_data_los_patients <- combined_data_los_patients %>%
  mutate(AGE_QUINTILE = cut(AGE_AT_ADMISSION, 
                             breaks = age_breaks_los,
                             include.lowest = TRUE,
                             labels = age_labels_los))

# Plot including age quintiles as facets for Length of Stay (LOS)
ggplot(combined_data_los_patients, aes(x = GENDER, y = LOS, fill = GENDER)) +
  geom_boxplot() +
  facet_wrap(~ AGE_QUINTILE, ncol = 3) +
  labs(title = "Length of Stay (LOS) by Gender and Age Quintile",
       x = "Gender",
       y = "Length of Stay (Days)") +
  scale_fill_manual(values = sample(color_palette, size = length(unique(patients$EXPIRE_FLAG)))) +
  theme_custom
```

Overall, this boxplot provides valuable insights into how gender and age influence the length of ICU stays, indicating that females may generally experience longer stays than males across the age spectrum, while patients with missing age data may represent a different patient population.

## 2.4. Exploratory analysis

### 2.4.1. Outcome 1: Death Status by Patients Data

```{r Death Status by Patients Data Exploratory analysis}
# Perform the statistical tests for both variables
result_age <- perform_statistical_tests(patients, "EXPIRE_FLAG", "AGE_AT_ADMISSION", "Age")
result_sex <- perform_statistical_tests(patients, "EXPIRE_FLAG", "GENDER", "Gender")

# Merge the results
merged_results <- bind_rows(result_age, result_sex)

print(merged_results)
```

Both **Age and Gender** show highly significant associations with death status (EXPIRE_FLAG), suggesting they are both important variables in explaining survival outcomes in this dataset.

### 2.4.2. Outcome 2: Length of Survival by Patients Data

```{r Length of Survival by Patients DataExploratory analysis}
patients_admissions <- admissions_outcome %>%
  left_join(patients, by = "SUBJECT_ID") %>%
  select(SUBJECT_ID, SURVIVAL, EXPIRE_FLAG, AGE_AT_ADMISSION, GENDER) %>%
  mutate(
    EXPIRE_FLAG = as.numeric(as.character(EXPIRE_FLAG))  # Ensure EXPIRE_FLAG is numeric
  )

# Generate Kaplan-Meier survival curve by GENDER
fit_gender <- survfit(Surv(SURVIVAL, EXPIRE_FLAG) ~ GENDER, data = patients_admissions)

# Plot the Kaplan-Meier curve
ggsurvplot(
  fit_gender,
  data = patients_admissions,
  pval = TRUE,  # Display p-value for gender
  conf.int = TRUE,  # Add confidence intervals
  ggtheme = theme_custom,
  surv.median.line = "hv",
  legend.title = "Gender",
  title = "Survival Curve by Gender",
  palette =  color_palette
)

# Create age groups based on AGE_AT_ADMISSION
patients_admissions <- patients_admissions %>%
  mutate(
    AGE_GROUP = cut(AGE_AT_ADMISSION,
                    breaks = c(0, 18, 40, 60, 100), 
                    labels = c("0-18", "19-40", "41-60", "61+"),
                    right = FALSE)  # Include the left boundary in each group
  )

# Fit the Kaplan-Meier survival curve by age group
fit_age_group <- survfit(Surv(SURVIVAL, EXPIRE_FLAG) ~ AGE_GROUP, data = patients_admissions)

# Plot the Kaplan-Meier curve for the age groups
ggsurvplot(
  fit_age_group,
  data = patients_admissions,
  pval = TRUE,  # Display p-value for age groups
  conf.int = TRUE,  # Add confidence intervals
  ggtheme = theme_custom,
  surv.median.line = "hv",
  legend.title = "Age Group",
  title = "Survival Curve by Age Group",
  palette = color_palette
)

hr_table <- HR_assessment("SURVIVAL", "EXPIRE_FLAG", c("GENDER", "AGE_AT_ADMISSION"), patients_admissions)

print(hr_table)

```

**GENDER:** There is no statistically significant effect of gender on survival in data. The p-value for gender is above the typical threshold of 0.05, and the confidence interval includes 1, indicating no strong evidence of an association.

**AGE_AT_ADMISSION:** Age is a significant predictor of survival. The positive hazard ratio of 1.04 means that older patients are at a slightly higher risk of the event (death, etc.), and this result is statistically significant (p-value < 0.0001).

### 2.4.3. Outcome 3: Length of ICU Stay by Patients Data

``` {r Length of ICU Stay by Patients Data}
result_age <- analyze_predictor_LOS(combined_data_los_patients, predictor = "AGE_AT_ADMISSION", LOS = "LOS", patient_id = "SUBJECT_ID")
result_sex <- analyze_predictor_LOS(combined_data_los_patients, predictor = "GENDER", LOS = "LOS", patient_id = "SUBJECT_ID")

# Merge the results
merged_results <- bind_rows(result_age, result_sex)
print(merged_results)

```

# 3. Admissions Data

## 3.1. Read and Prepare Data

```{r read file}
skimr::skim(admissions)
```

## 3.2. Desriptive statistics

### 3.2.1. Descriptive statistics for categorical variables (Admission data)

```{r descriptive statistica admissions}
# Clean and summarize the categorical data for all factor variables
admissions %>%
  select(ADMISSION_TYPE, INSURANCE, RELIGION, MARITAL_STATUS, ETHNICITY) %>%
  select(where(is.factor)) %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "Value") %>%
  group_by(Variable, Value) %>%
  summarise(n = n(), .groups = 'drop') %>%
  group_by(Variable) %>%
  mutate(`No data` = sum(is.na(Value)),
         `% by group` = (n / sum(n)) * 100) %>%
  ungroup() %>%
  select(Variable, Value, n, `% by group`, `No data`) %>%
  arrange(Variable, Value) %>%
  flextable() %>%
  merge_v("Variable") %>%
  autofit() %>%
  border_inner(border = fp_border(color = "black", width = 1)) %>%
  border_outer(border = fp_border(color = "black", width = 1))
```

## 3.3. Visualisation Analysis by Outcome

### 3.3.1. Outcome 1: Death Status by Admissions Data

```{r death status by admissions data}
patients_admissions <- patients %>%
  left_join(admissions, by = "SUBJECT_ID")

# Prepare the data for plotting
patients_admissions_long <- patients_admissions %>%
  select(EXPIRE_FLAG, ADMISSION_TYPE, INSURANCE, RELIGION, MARITAL_STATUS, ETHNICITY) %>%
  pivot_longer(cols = -EXPIRE_FLAG, names_to = "Variable", values_to = "Value")

# List of categorical variables to plot
categorical_vars <- c("ADMISSION_TYPE", "INSURANCE", "RELIGION", "MARITAL_STATUS", "ETHNICITY")

# Loop through each variable and create a bar plot
for (var in categorical_vars) {
  p <- ggplot(patients_admissions_long[patients_admissions_long$Variable == var, ], aes(x = Value, fill = EXPIRE_FLAG)) +
    geom_bar(position = "dodge2", color = "black") +
    geom_text(stat = "count", aes(label = after_stat(count)), 
              position = position_dodge(width = 0.9), 
              vjust = -0.5, size = 3) +  # Adjust label position and size
    labs(title = paste("Death Status by", var),
         x = "Category",
         y = "Count",
         fill = "Death Status") +
    theme_custom +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +  # Rotate x-axis labels
    scale_fill_manual(values = sample(color_palette, size = length(unique(patients$EXPIRE_FLAG))), labels = c("0" = "Not Dead", "1" = "Dead"))
  
  # Print or save the plot
  print(p)
}

```

### 3.3.2. Outcome 2: Length of Survival by Admissions Data

``` {r Outcome 2: Length of Survival by Admissions Data visualisation}

admissions_clean <- admissions_outcome %>%
  left_join(admissions, by = c("SUBJECT_ID", "SURVIVAL"))

# Plot 1: ADMISSION_TYPE
plot_admission <- ggplot(admissions_clean, aes(x = ADMISSION_TYPE, y = SURVIVAL, fill = ADMISSION_TYPE)) +
  geom_boxplot() +
  labs(title = "Survival by Admission Type",
       x = "Admission Type",
       y = "Survival (Days)") +
  scale_fill_manual(values = sample(color_palette, size = length(unique(admissions_clean$ADMISSION_TYPE)))) +
  theme_custom

# Plot 2: INSURANCE
plot_insurance <- ggplot(admissions_clean, aes(x = INSURANCE, y = SURVIVAL, fill = INSURANCE)) +
  geom_boxplot() +
  labs(title = "Survival by Insurance Type",
       x = "Insurance",
       y = "Survival (Days)") +
  scale_fill_manual(values = sample(color_palette, size = length(unique(admissions_clean$INSURANCE)))) +
  theme_custom

# Plot 3: MARITAL_STATUS
plot_marital_status <- ggplot(admissions_clean, aes(x = MARITAL_STATUS, y = SURVIVAL, fill = MARITAL_STATUS)) +
  geom_boxplot() +
  labs(title = "Survival by Marital Status",
       x = "Marital Status",
       y = "Survival (Days)") +
  scale_fill_manual(values = sample(color_palette, size = length(unique(admissions_clean$MARITAL_STATUS)))) +
  theme_custom

# Plot 4: ETHNICITY
plot_ethnicity <- ggplot(admissions_clean, aes(x = ETHNICITY, y = SURVIVAL, fill = ETHNICITY)) +
  geom_boxplot() +
  labs(title = "Survival by Ethnicity",
       x = "Ethnicity",
       y = "Survival (Days)") +
  scale_fill_manual(values = sample(color_palette, size = length(unique(admissions_clean$ETHNICITY)))) +
  theme_custom

# Plot 5: RELIGION
plot_religion <- ggplot(admissions_clean, aes(x = RELIGION, y = SURVIVAL, fill = RELIGION)) +
  geom_boxplot() +
  labs(title = "Survival by Religion",
       x = "Religion",
       y = "Survival (Days)") +
  scale_fill_manual(values = sample(color_palette, size = length(unique(admissions_clean$RELIGION)))) +
  theme_custom

# Function to create the plot
create_admission_plot <- function(data, x_var, color_palette, theme_custom) {
  ggplot(data, aes_string(x = x_var, y = "SURVIVAL", fill = x_var, color = x_var)) +
    geom_boxplot(outlier.shape = NA, alpha = 0.7) +
    geom_jitter(width = 0.2, alpha = 0.5, fill = "white", shape = 21, size = 2, stroke = 0.5) +
    theme_custom +
    scale_fill_manual(values = color_palette) +  # Color for boxplot fill
    scale_color_manual(values = color_palette) + # Color for jitter points
    labs(
      title = paste("Time to Death by", x_var),
      y = "Time to Death (Days)", x = x_var
    ) +
    theme(
      legend.position = "none",
      strip.text = element_text(size = 12, face = "bold")
    )
}

# Define the admission variables
admission_vars <- c("ADMISSION_TYPE", "INSURANCE", "MARITAL_STATUS", "ETHNICITY", "RELIGION")

# Create a list to store the plots
plots <- lapply(admission_vars, function(var) {
  create_admission_plot(admissions_clean, var, color_palette, theme_custom)
})

# Name the plots for easy reference
names(plots) <- admission_vars
for (var_name in names(plots)) {
  cat("\nPlot for:", var_name, "\n")  # Print the variable name
  print(plots[[var_name]])
}

``` 

### 3.3.3. Outcome 3: Length of ICU Stay by Admissions Data

``` {r Outcome 3: Length of ICU Stay by Admissions Data visualisation}

# Clean and prepare the data
combined_data_los_admissions <- admissions %>%
  left_join(icu_stays_outcome, by = c("SUBJECT_ID", "HADM_ID"))

# ADMISSION_TYPE
plot_admission_icu <- ggplot(combined_data_los_admissions, aes(x = ADMISSION_TYPE, y = LOS, fill = ADMISSION_TYPE)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.2, alpha = 0.5, color = "black") +
  labs(title = "Length of ICU Stay by Admission Type",
       x = "Admission Type",
       y = "Length of ICU Stay (Days)") +
  scale_fill_manual(values = sample(color_palette, size = length(unique(combined_data_los_admissions$ADMISSION_TYPE)))) +
  theme_custom

# Plot 2: INSURANCE
plot_insurance_icu <- ggplot(combined_data_los_admissions, aes(x = INSURANCE, y = LOS, fill = INSURANCE)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.2, alpha = 0.5, fill = "white", shape = 21, size = 2, stroke = 0.5) +
  labs(title = "Length of ICU Stay by Insurance Type",
       x = "Insurance Type",
       y = "Length of ICU Stay (Days)") +
  scale_fill_manual(values = sample(color_palette, size = length(unique(combined_data_los_admissions$INSURANCE)))) +
  theme_custom

# Plot 3: MARITAL_STATUS
plot_marital_status_icu <- ggplot(combined_data_los_admissions, aes(x = MARITAL_STATUS, y = LOS, fill = MARITAL_STATUS)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.2, alpha = 0.5, color = "black") +
  labs(title = "Length of ICU Stay by Marital Status",
       x = "Marital Status",
       y = "Length of ICU Stay (Days)") +
  scale_fill_manual(values = sample(color_palette, size = length(unique(combined_data_los_admissions$MARITAL_STATUS)))) +
  theme_custom

# Plot 4: ETHNICITY
plot_ethnicity_icu <- ggplot(combined_data_los_admissions, aes(x = ETHNICITY, y = LOS, fill = ETHNICITY)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.2, alpha = 0.5, color = "black") +
  labs(title = "Length of ICU Stay by Ethnicity",
       x = "Ethnicity",
       y = "Length of ICU Stay (Days)") +
  scale_fill_manual(values = sample(color_palette, size = length(unique(combined_data_los_admissions$ETHNICITY)))) +
  theme_custom

# Plot 5: RELIGION
plot_religion_icu <- ggplot(combined_data_los_admissions, aes(x = RELIGION, y = LOS, fill = RELIGION)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(width = 0.2, alpha = 0.5, color = "black") +
  labs(title = "Length of ICU Stay by Religion",
       x = "Religion",
       y = "Length of ICU Stay (Days)") +
  scale_fill_manual(values = sample(color_palette, size = length(unique(combined_data_los_admissions$RELIGION)))) +
  theme_custom

# Function to create the plot
create_icu_plot <- function(data, x_var, color_palette, theme_custom) {
  ggplot(data, aes_string(x = x_var, y = "LOS", fill = x_var, color = x_var)) +
    geom_boxplot(outlier.shape = NA, alpha = 0.7) +
    geom_jitter(width = 0.2, alpha = 0.5, fill = "white", shape = 21, size = 2, stroke = 0.5) +
    theme_custom +
    scale_fill_manual(values = color_palette) +  # Color for boxplot fill
    scale_color_manual(values = color_palette) + # Color for jitter points
    labs(
      title = paste("Length of ICU Stay by", x_var),
      y = "Length of ICU Stay (Days)", x = x_var
    ) +
    theme(
      legend.position = "none",
      strip.text = element_text(size = 12, face = "bold")
    )
}

# Define the ICU variables
icu_vars <- c("ADMISSION_TYPE", "INSURANCE", "MARITAL_STATUS", "ETHNICITY", "RELIGION")

# Create a list to store the ICU plots
icu_plots <- lapply(icu_vars, function(var) {
  create_icu_plot(combined_data_los_admissions, var, color_palette, theme_custom)
})

# Name the plots for easy reference
names(icu_plots) <- icu_vars
for (var_name in names(icu_plots)) {
  cat("\nPlot for:", var_name, "\n")  # Print the variable name
  print(icu_plots[[var_name]])
}


```

## 3.4. Exploratory analysis
### 3.4.1. Outcome 1: Death Status by Admissions Data

```{r Death Status by Admissions Data }
patients_admissions <- admissions_clean %>%
  left_join(patients, by = "SUBJECT_ID") %>%
  select(SUBJECT_ID, SURVIVAL, EXPIRE_FLAG, ADMISSION_TYPE, INSURANCE, MARITAL_STATUS, RELIGION, ETHNICITY ) %>%
  mutate(
    EXPIRE_FLAG = as.numeric(as.character(EXPIRE_FLAG))  # Ensure EXPIRE_FLAG is numeric
  )

# Perform the statistical tests for both variables
patients_admissions$ADMISSION_TYPE <- droplevels(patients_admissions$ADMISSION_TYPE)

result_ADMISSION_TYPE <- perform_statistical_tests(patients_admissions, "EXPIRE_FLAG", "ADMISSION_TYPE", "ADMISSION TYPE")
result_INSURANCE <- perform_statistical_tests(patients_admissions, "EXPIRE_FLAG", "INSURANCE", "INSURANCE")
result_RELIGION <- perform_statistical_tests(patients_admissions, "EXPIRE_FLAG", "RELIGION", "RELIGION")
result_MARITAL_STATUS <- perform_statistical_tests(patients_admissions, "EXPIRE_FLAG", "MARITAL_STATUS", "MARITAL STATUS")
result_ETHNICITY <- perform_statistical_tests(patients_admissions, "EXPIRE_FLAG", "ETHNICITY", "ETHNICITY")

# Merge the results
merged_results <- bind_rows(result_ADMISSION_TYPE, result_INSURANCE, result_RELIGION, result_MARITAL_STATUS, result_ETHNICITY)

print(merged_results)

```

### 3.4.2. Outcome 2: Length of Survival by Admissions Data

```{r Length of Survival by Admissions Data exploratory analysis}

# Generate Kaplan-Meier survival curve by GENDER
fit_admission_type <- survfit(Surv(SURVIVAL, EXPIRE_FLAG) ~ ADMISSION_TYPE, data = patients_admissions)

# Plot the Kaplan-Meier curve
ggsurvplot(
  fit_admission_type,
  data = patients_admissions,
  pval = TRUE,  # Display p-value for gender
  conf.int = TRUE,  # Add confidence intervals
  ggtheme = theme_custom,
  surv.median.line = "hv",
  legend.title = "Admission type",
  title = "Survival Curve by Admission Type",
  palette =  color_palette
)

# Generate Kaplan-Meier survival curve by GENDER
fit_insurance <- survfit(Surv(SURVIVAL, EXPIRE_FLAG) ~ INSURANCE, data = patients_admissions)


# Plot the Kaplan-Meier curve 
ggsurvplot(
  fit_insurance,
  data = patients_admissions,
  pval = TRUE,  # Display p-value for age groups
  conf.int = TRUE,  # Add confidence intervals
  ggtheme = theme_custom,
  surv.median.line = "hv",
  legend.title = "Insurance",
  title = "Survival Curve by Insurance",
  palette = color_palette
)

# Fit Kaplan-Meier model
fit_religion <- survfit(Surv(SURVIVAL, EXPIRE_FLAG) ~ RELIGION, data = patients_admissions)

# Plot the Kaplan-Meier curve
ggsurvplot(
  fit_religion,
  data = patients_admissions,
  pval = TRUE,  # Display p-value
  conf.int = TRUE,  # Add confidence intervals
  ggtheme = theme_custom,
  surv.median.line = "hv",
  legend.title = "Religion",
  title = "Survival Curve by Religion",
  palette = color_palette
)

# Fit Kaplan-Meier model
fit_marital_status <- survfit(Surv(SURVIVAL, EXPIRE_FLAG) ~ MARITAL_STATUS, data = patients_admissions)

# Plot the Kaplan-Meier curve
ggsurvplot(
  fit_marital_status,
  data = patients_admissions,
  pval = TRUE,  # Display p-value
  conf.int = TRUE,  # Add confidence intervals
  ggtheme = theme_custom,
  surv.median.line = "hv",
  legend.title = "Marital Status",
  title = "Survival Curve by Marital Status",
  palette = color_palette
)

# Fit Kaplan-Meier model
fit_ethnicity <- survfit(Surv(SURVIVAL, EXPIRE_FLAG) ~ ETHNICITY, data = patients_admissions)

# Plot the Kaplan-Meier curve
ggsurvplot(
  fit_ethnicity,
  data = patients_admissions,
  pval = TRUE,  # Display p-value
  conf.int = TRUE,  # Add confidence intervals
  ggtheme = theme_custom,
  surv.median.line = "hv",
  legend.title = "Ethnicity",
  title = "Survival Curve by Ethnicity",
  palette = color_palette
)

hr_table <- HR_assessment("SURVIVAL", "EXPIRE_FLAG", c("ADMISSION_TYPE", "INSURANCE", "MARITAL_STATUS", "RELIGION", "ETHNICITY"), patients_admissions)

print(hr_table)

```

### 3.4.3. Outcome 3: Length of ICU Stay by Admissions Data

``` {r Length of ICU Stay by Admission Data}

result_ADMISSION_TYPE <- analyze_predictor_LOS(combined_data_los_admissions, predictor = "ADMISSION_TYPE", LOS = "LOS", patient_id = "SUBJECT_ID")
result_INSURANCE <- analyze_predictor_LOS(combined_data_los_admissions, predictor = "INSURANCE", LOS = "LOS", patient_id = "SUBJECT_ID")
result_RELIGION <- analyze_predictor_LOS(combined_data_los_admissions, predictor = "RELIGION", LOS = "LOS", patient_id = "SUBJECT_ID")
result_MARITAL_STATUS <- analyze_predictor_LOS(combined_data_los_admissions, predictor = "MARITAL_STATUS", LOS = "LOS", patient_id = "SUBJECT_ID")
result_ETHNICITY <- analyze_predictor_LOS(combined_data_los_admissions, predictor = "ETHNICITY", LOS = "LOS", patient_id = "SUBJECT_ID")

# Merge the results
merged_results <- bind_rows(result_ADMISSION_TYPE, result_INSURANCE, result_RELIGION, result_MARITAL_STATUS, result_ETHNICITY)

print(merged_results)
```

# 4.   Diagnoses Data
## 4.1.   Read Data

``` {r read data diagnoses}
diagnoses <- read.csv("../data/raw/cleaned/DIAGNOSES_ICD_clean.csv", stringsAsFactors = TRUE) %>%
  mutate(across(where(is.character), as.factor))  %>%
  filter(SUBJECT_ID %in% subject_ids_adults) %>%
  mutate(SUBJECT_ID = as.factor(SUBJECT_ID))

skimr::skim(diagnoses %>%
              select(-SUBJECT_ID, -ROW_ID))
```

## 4.2.   Descriptive Statistics
### 4.2.1. Descriptive statistics for numerical variables (Diagnoses)

```{r descriptive statistics for numerical vars (Diagnoses)}
# Summarize the statistics for each numeric variable
diagnoses %>%
  select(SUBJECT_ID, DIAGNOSES_NUM) %>%
  distinct() %>% # one number for 1 patient
  select(DIAGNOSES_NUM) %>%
  summarise(across(everything(), statistics)) %>%
  pivot_longer(cols = everything(), names_sep = "__", names_to = c("Variable", "Stat")) %>%
  rename(`Value` = value) %>%
  flextable() %>%
  merge_v("Variable") %>%
  width(j = c("Variable", "Stat", "Value"), width = 2) %>%
  autofit() %>%
  border_inner(border = fp_border(color = "black", width = 1)) %>%
  border_outer(border = fp_border(color = "black", width = 1))
```

### 4.2.2. Descriptive statistics for categorical variables (Diagnoses)

```{r Descriptive statistics patients for categorical vars (Diagnoses)}
# Clean and summarize the categorical data for all factor variables
diagnoses %>%
  filter(SEQ_NUM == 1) %>%
  select(where(is.factor), -SHORT_TITLE, -ICD9_CODE) %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "Value") %>%
  group_by(Variable, Value) %>%
  summarise(n = n(), .groups = 'drop') %>%
  group_by(Variable) %>%
  mutate(`No data` = sum(is.na(Value)),
         `% by group` = (n / sum(n)) * 100) %>%
  ungroup() %>%
  filter(n >= 100) %>% # Keep only rows with at least 1000 observations
  select(Variable, Value, n, `% by group`, `No data`) %>%
  arrange(Variable, desc(n), Value) %>% # Sort by Variable and descending frequency (n)
  flextable() %>%
  merge_v("Variable") %>%
  autofit() %>%
  border_inner(border = fp_border(color = "black", width = 1)) %>%
  border_outer(border = fp_border(color = "black", width = 1))

```

## 4.3. Visualisation Analysis by Outcome

### 4.3.1. Outcome 1: Death Status by Diagnoses

``` {r Death Status by Diagnoses}
# Visualize how distributes diagnoses with high-priority diagnosis
high_priority <- diagnoses %>%
  filter(SEQ_NUM == 1) %>%
  count(LONG_TITLE, sort = TRUE) %>%
  mutate(Percentage = n / sum(n) * 100,
         Cumulative_Percentage = cumsum(Percentage)) %>%
  filter(Cumulative_Percentage <= 30) # Keep diagnoses contributing to top 30%

ggplot(high_priority, aes(x = reorder(LONG_TITLE, -n), y = n)) +
  geom_bar(stat = "identity", fill = color_palette[6], color = "black") +
  geom_text(aes(label = n), vjust = 1.3, size = 3) +
  labs(title = "High-Priority Diagnoses (contributing to top 30%)",
       x = "ICD9 Code",
       y = "Frequency") +
  theme_custom +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Visualize how many diagnoses (DIAGNOSES_NUM unique number for each patients) has patients who died and who not 

diagnoses_death_outcome <- patients %>%
  left_join(diagnoses, by = "SUBJECT_ID") %>%
  select(SUBJECT_ID, EXPIRE_FLAG, LONG_TITLE, SEQ_NUM, DIAGNOSES_NUM)

# Simplified dataset: Ensure DIAGNOSES_NUM is directly used
diagnoses_death_summary <- diagnoses_death_outcome %>%
  group_by(EXPIRE_FLAG) %>%
  summarise(
    Mean_Diagnoses = mean(DIAGNOSES_NUM, na.rm = TRUE),
    Median_Diagnoses = median(DIAGNOSES_NUM, na.rm = TRUE),
    Count = n(),
    .groups = "drop"
  )

# Bar plot: Average number of diagnoses by death status
ggplot(diagnoses_death_summary, aes(x = factor(EXPIRE_FLAG), y = Mean_Diagnoses, fill = factor(EXPIRE_FLAG))) +
  geom_bar(stat = "identity", position = "dodge", width = 0.6, color = "black") +
  geom_text(aes(label = round(Mean_Diagnoses, 1)), vjust = -0.5, size = 3) +
  labs(title = "Mean Number of Diagnoses by Death Status",
       x = "Death Status (0 = Survived, 1 = Died)",
       y = "Mean Number of Diagnoses",
       fill = "Death Status") +
  scale_fill_manual(values = sample(color_palette, size = length(unique(patients$EXPIRE_FLAG)), replace = FALSE), labels = c("0" = "Not Dead", "1" = "Dead")) +
  theme_custom +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5))
```

### 4.3.2. Outcome 2: Length of Survival by Diagnoses

```{r length of survival by diagnoses}
# Merge admissions and high-priority diagnoses
top_diagnoses <- diagnoses %>%
  filter(SEQ_NUM == 1) %>%
  count(LONG_TITLE, sort = TRUE) %>%
  mutate(Percentage = n / sum(n) * 100,
         Cumulative_Percentage = cumsum(Percentage)) %>%
  filter(Cumulative_Percentage <= 30) %>%
  select(LONG_TITLE)

# Join with admissions_outcome to retain survival data
diagnoses_admissions_high_priority <- admissions_outcome %>%
  left_join(diagnoses, by = "SUBJECT_ID") %>% 
  filter(SEQ_NUM == 1, LONG_TITLE %in% top_diagnoses$LONG_TITLE)

# Plot: High-priority diagnosis by SURVIVAL length
ggplot(diagnoses_admissions_high_priority, aes(x = LONG_TITLE, y = SURVIVAL, fill = LONG_TITLE, color = LONG_TITLE)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.7) +
  geom_jitter(width = 0.2, alpha = 0.5, fill = "white", shape = 21, size = 2, stroke = 0.5) +
  labs(title = "High-Priority Diagnoses by Survival Length",
       x = "High-Priority Diagnosis",
       y = "Survival Length (Days)") +
  scale_fill_manual(values = color_palette) +
  scale_color_manual(values = color_palette) +
  theme_custom +
  theme(
    legend.position = "none",,
    axis.text.x = element_text(angle = 45, hjust = 1)
    )

# Merge admissions and diagnoses
diagnoses_admissions_outcome <- admissions_outcome %>%
  left_join(diagnoses, by = "SUBJECT_ID") %>%
  select(SUBJECT_ID, SURVIVAL, LONG_TITLE, SEQ_NUM, DIAGNOSES_NUM)

# Plot: Average number of diagnoses per patient by survival length
diagnoses_admissions_outcome %>%
  group_by(SURVIVAL) %>%
  summarise(Average_Diagnoses = mean(DIAGNOSES_NUM, na.rm = TRUE), .groups = "drop") %>%
  ggplot(aes(x = SURVIVAL, y = Average_Diagnoses)) +
  geom_line(color = color_palette[10], size = 1.2) +  # Line for trend
  geom_point(color = color_palette[22], fill = "white", shape = 21, size = 2, stroke = 0.5) +  # Dots with outline
  geom_smooth(method = "loess", color = "darkblue", fill = "blue", alpha = 0.2, size = 1, se = TRUE) +  # LOESS smooth trend
  labs(
    title = "Average Number of Diagnoses by Survival Length",
    x = "Survival Length (Days)",
    y = "Average Number of Diagnoses"
  ) +
  scale_x_continuous(limits = c(0, max(diagnoses_admissions_outcome$SURVIVAL, na.rm = TRUE)), expand = c(0, 0)) + 
  scale_y_continuous(expand = c(0, 0)) + 
  theme_custom +
  theme(
    panel.grid.major = element_line(color = "grey40", size = 0.5),  # Add gridlines
    panel.grid.minor = element_line(color = "grey95", size = 0.25)
  )

```

## 4.4. Exploratory analysis
### 4.4.1. Outcome 1: Death Status by Diagnoses

``` {r Death Status by Diagnoses exploratory analysis}
diagnoses_death_outcome$LONG_TITLE <- droplevels(diagnoses_death_outcome$LONG_TITLE)
result_diagnoses_num <- perform_statistical_tests(diagnoses_death_outcome, "EXPIRE_FLAG", "DIAGNOSES_NUM", "Diagnoses number")

result_all_diagnosis <- perform_statistical_tests(diagnoses_death_outcome, "EXPIRE_FLAG", "LONG_TITLE", "Diagnosis")

high_priority <- diagnoses_death_outcome %>%
  filter(SEQ_NUM == 1)

result_high_priority <- perform_statistical_tests(high_priority, "EXPIRE_FLAG", "LONG_TITLE", "Key Diagnosis")

merged_results <- bind_rows(result_diagnoses_num, result_all_diagnosis, result_high_priority)

print(merged_results)
```

