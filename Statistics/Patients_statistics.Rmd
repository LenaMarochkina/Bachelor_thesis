---
title: "Statistical Analysis"
author: "Elena Marochkina"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: yes
    toc_depth: 4
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, echo = FALSE)

```

```{r libraries, set colors}
library(tidyverse)
library(readr)
library(dplyr)
library(tidyr)
library(flextable)
library(officer)
library(RColorBrewer)
library(broom)
library(tibble)
library(nortest)
library(survival)
library(survminer)
library(ggpubr)
library(lme4)   
library(lmerTest) 
library(glmnet)


# Custom theme for visualisations
theme_custom <- theme_minimal() +
  theme (
    plot.title = element_text(size = 14, hjust = 0.5),
    plot.subtitle = element_text(size = 12, hjust = 0.5),
    strip.text = element_text(size = 10),
    axis.text = element_text(size = 8),
    axis.title = element_text(size = 12),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 10),
    axis.line = element_line(color = "black"),
    axis.ticks = element_line(color = "black"),
  )

# Palette for visualisations
color_palette <- c(brewer.pal(9, "Pastel1"), brewer.pal(8, "Pastel2"), brewer.pal(8, "Set3"))

```

```{r Descriptive Stat functions}
# Function to calculate 95% confidence interval for the mean
ci_95 <- function(x) {
  n <- sum(!is.na(x))
  if (n < 3) return("Н/П*")
  se <- sd(x, na.rm = TRUE) / sqrt(n)  # Standard Error
  mean_x <- mean(x, na.rm = TRUE)
  ci <- c(mean_x - 1.96 * se, mean_x + 1.96 * se)
  paste0(round(ci[1], 2), " - ", round(ci[2], 2))
}

# List of descriptive statistics
statistics <- list(
  `_Number of values` = ~as.character(sum(!is.na(.x))),
  `_No data` = ~as.character(sum(is.na(.x))),
  `_Mean` = ~ifelse(sum(!is.na(.x)) == 0, "NA", as.character(mean(.x, na.rm = TRUE) %>% round(2))),
  `_Median` = ~ifelse(sum(!is.na(.x)) == 0, "NA", as.character(median(.x, na.rm = TRUE) %>% round(2))),
  `_SD` = ~ifelse(sum(!is.na(.x)) < 3, "NA", as.character(sd(.x, na.rm = TRUE) %>% round(2))),
  `_Q1 - Q3` = ~ifelse(sum(!is.na(.x)) == 0, "NA", paste0(as.character(quantile(.x, 0.25, na.rm = TRUE) %>% round(2)), " - ", as.character(quantile(.x, 0.75, na.rm = TRUE) %>% round(2)))),
  `_IQR` = ~ifelse(sum(!is.na(.x)) == 0, "NA", as.character(IQR(.x, na.rm = TRUE) %>% round(2))),
  `_95% CI` = ~ci_95(.x),
  `_min` = ~ifelse(sum(!is.na(.x)) == 0, "NA", as.character(min(.x, na.rm = TRUE) %>% round(2))),
  `_max` = ~ifelse(sum(!is.na(.x)) == 0, "NA", as.character(max(.x, na.rm = TRUE) %>% round(2)))
)

```

``` {r Statictical hypothesis check}
perform_statistical_tests <- function(data, dependent_var, independent_var, variable_name) {
  result_table <- tibble(Variable = character(),
                         Performed_test = character(),
                         Result = character(),
                         Interpretation = character())
  
  # Format p-value helper function
  format_p_value <- function(p) {
    if (p < 0.0001) {
      return("< 0.0001")  # Very small p-values
    } else {
      return(formatC(p, format = "f", digits = 4))  # Standard decimal notation
    }
  }
  
  # Check the type of independent variable
  if (is.numeric(data[[independent_var]])) {
    # If independent variable is numeric
    if (length(data[[independent_var]][!is.na(data[[independent_var]])]) > 3) {
      ad_result <- nortest::ad.test(data[[independent_var]][!is.na(data[[independent_var]])])
      
      if (ad_result$p.value > 0.05) {
        # Normal distribution
        t_test_result <- t.test(data[[independent_var]] ~ as.factor(data[[dependent_var]]), data = data)
        result_table <- result_table %>%
          add_row(
            Variable = variable_name,
            Performed_test = "T-Test",
            Result = format_p_value(t_test_result$p.value),
            Interpretation = ifelse(t_test_result$p.value < 0.05, "Significant", "Not significant")
          )
      } else {
        # Not normally distributed
        if (length(unique(data[[dependent_var]])) == 2) {
          mw_test_result <- wilcox.test(data[[independent_var]] ~ as.factor(data[[dependent_var]]), data = data)
          result_table <- result_table %>%
            add_row(
              Variable = variable_name,
              Performed_test = "Mann-Whitney U Test",
              Result = format_p_value(mw_test_result$p.value),
              Interpretation = ifelse(mw_test_result$p.value < 0.05, "Significant", "Not significant")
            )
        } else {
          stop("Dependent variable must have exactly two levels for Mann-Whitney U Test.")
        }
      }
    } else {
      stop("Not enough data points for Anderson-Darling test.")
    }
    
  } else if (is.factor(data[[independent_var]]) || is.character(data[[independent_var]])) {
    # If independent variable is categorical
    data[[dependent_var]] <- as.factor(data[[dependent_var]])
    contingency_table <- table(data[[independent_var]], data[[dependent_var]])
    
    # Check for zero counts
    if (any(contingency_table == 0)) {
      # Remove rows and columns with all zeros
      contingency_table <- contingency_table[rowSums(contingency_table) > 0, colSums(contingency_table) > 0]
      
      # If the table is now empty, stop with a warning
      if (nrow(contingency_table) == 0 || ncol(contingency_table) == 0) {
        stop("Contingency table is empty after removing zero counts.")
      }
      
      # Optionally merge low-frequency categories into "Other"
      data[[independent_var]] <- as.character(data[[independent_var]])
      low_frequency <- rownames(contingency_table)[rowSums(contingency_table) <= 5]  # Adjust threshold as needed
      data[[independent_var]][data[[independent_var]] %in% low_frequency] <- "Other"
      
      # Recalculate the table
      contingency_table <- table(data[[independent_var]], data[[dependent_var]])
    }
    
    # Perform Chi-Square Test
    chi_square_result <- chisq.test(contingency_table, simulate.p.value = TRUE)
    result_table <- result_table %>%
      add_row(
        Variable = variable_name,
        Performed_test = "Chi-Squared Test",
        Result = format_p_value(chi_square_result$p.value),
        Interpretation = ifelse(chi_square_result$p.value < 0.05, "Significant", "Not significant")
      )
  } else {
    stop("Independent variable must be either numeric or categorical.")
  }
  
  if (nrow(result_table) == 0) {
    stop("No valid tests were performed. Check your data and variables.")
  }
  
  return(result_table)
}


```

``` {r Survival Analysis}
HR_assessment <- function(survival_time, event_status, predictors, data) {
  
  # Create the formula for the Cox model
  formula <- as.formula(paste("Surv(", survival_time, ", ", event_status, ") ~", paste(predictors, collapse = " + ")))
  
  # Fit the Cox model
  cox_model <- coxph(formula, data = data)
  
  # Extract hazard ratios and confidence intervals
  hr <- exp(coef(cox_model))  # Hazard ratios
  hr_ci <- exp(confint(cox_model))  # Confidence intervals
  
  # Extract p-values
  p_values <- summary(cox_model)$coefficients[, "Pr(>|z|)"]
  
  # Get the variable names corresponding to each coefficient
  variable_names <- names(coef(cox_model))
  
  # Format p-values helper function
  format_p_value <- function(p) {
    if (is.na(p)) {
      return("NA")  # Handle missing p-values
    } else if (p < 0.0001) {
      return("< 0.0001")  # Very small p-values
    } else {
      return(formatC(p, format = "f", digits = 4))  # Standard decimal notation
    }
  }
  
  # Add interpretation logic
  interpret_hr <- function(hr) {
    if (is.na(hr)) {
      return("NA")  # Handle missing HRs
    } else if (hr > 1) {
      return("Increased risk")
    } else if (hr == 1) {
      return("No change in risk")
    } else {
      return("Decreased risk")
    }
  }
  
  # Create a tibble with hazard ratios, confidence intervals, p-values, and interpretations
  hr_table <- tibble(
    Variable = variable_names,
    Hazard_Ratio = hr,
    Lower_CI = hr_ci[, 1],
    Upper_CI = hr_ci[, 2],
    p_value = sapply(p_values, format_p_value),  # Apply p-value formatting
    Interpretation = sapply(hr, interpret_hr)   # Apply HR interpretation
  )
  
  # Return the hazard ratio table
  return(hr_table)
}

```

```{r penalized COX Regression}
# Function to run Penalized Cox Regression
run_penalized_cox <- function(data, survival_time, event_status, predictors, penalty = "lasso") {
  # Define alpha based on penalty type
  alpha_value <- ifelse(penalty == "lasso", 1, 0)  # LASSO = 1, Ridge = 0
  
  # Prepare survival object and predictors matrix
  survival_outcome <- with(data, Surv(get(survival_time), get(event_status)))
  predictor_matrix <- model.matrix(~ . -1, data = data[, predictors, drop = FALSE])
  
  # Cross-validated penalized Cox model
  cv_model <- cv.glmnet(
    x = predictor_matrix,
    y = survival_outcome,
    family = "cox",
    alpha = alpha_value
  )
  
  # Get coefficients at optimal lambda
  optimal_coefs <- coef(cv_model, s = "lambda.min")
  
  # Return key results
  list(
    optimal_lambda = cv_model$lambda.min,
    coefficients = optimal_coefs,
    significant_features = rownames(optimal_coefs)[as.matrix(optimal_coefs) != 0],
    cv_model = cv_model
  )
}
```

``` {r LOS Analysis}
analyze_predictor_LOS <- function(data, predictor, LOS, patient_id) {
  
  # Helper function to format p-values
  format_p_value <- function(p) {
    if (p < 0.0001) {
      return("< 0.0001")  # Very small p-values
    } else {
      return(formatC(p, format = "f", digits = 4))  # Standard decimal notation with 4 digits
    }
  }

  # Validate Inputs
  if (!(predictor %in% colnames(data))) {
    stop(paste("Error: Predictor column", predictor, "does not exist in the dataset."))
  }
  if (!(LOS %in% colnames(data))) {
    stop(paste("Error: LOS column", LOS, "does not exist in the dataset."))
  }
  if (!(patient_id %in% colnames(data))) {
    stop(paste("Error: Patient ID column", patient_id, "does not exist in the dataset."))
  }

  # Check if LOS is numeric
  if (!is.numeric(data[[LOS]])) {
    stop("Error: LOS column must be numeric.")
  }

  # Check predictor type
  if (is.numeric(data[[predictor]])) {
    # Numerical predictor: Fit a mixed-effects linear regression model
    model <- lmer(as.formula(paste(LOS, "~", predictor, "+ (1 |", patient_id, ")")), data = data)
    model_summary <- summary(model)

    # Extract fixed-effect estimate and p-value
    fixed_effects <- tibble(
      Variable = predictor,
      Performed_test = "Mixed-Effects Linear Model",
      Statistic = model_summary$coefficients[predictor, "Estimate"],
      P_value = format_p_value(model_summary$coefficients[predictor, "Pr(>|t|)"]),
      Interpretation = ifelse(model_summary$coefficients[predictor, "Pr(>|t|)"] < 0.05, "Significant", "Not Significant")
    )

  } else if (is.factor(data[[predictor]]) || is.character(data[[predictor]])) {
    # Categorical predictor: Fit a mixed-effects linear regression model
    data[[predictor]] <- as.factor(data[[predictor]])  # Ensure it's a factor
    model <- lmer(as.formula(paste(LOS, "~", predictor, "+ (1 |", patient_id, ")")), data = data)
    model_summary <- summary(model)

    # Extract fixed-effect estimates and p-values for all levels of the categorical predictor
    fixed_effects <- as.data.frame(model_summary$coefficients) %>%
      rownames_to_column("Term") %>%
      filter(Term != "(Intercept)") %>%
      mutate(
        Variable = predictor,
        Performed_test = "Mixed-Effects Linear Model",
        Statistic = Estimate,
        P_value = sapply(`Pr(>|t|)`, format_p_value),
        Interpretation = ifelse(`Pr(>|t|)` < 0.05, "Significant", "Not Significant")
      ) %>%
      select(Variable, Term, Performed_test, Statistic, P_value, Interpretation) %>%
      as_tibble()  # Convert to tibble
  } else {
    stop("Error: Predictor must be numeric, factor, or character.")
  }

  # Return the result table as a tibble
  return(fixed_effects)
}

```


# 1. Outcomes Data

## 1.1. Read Data

```{r read files}
patients <- read.csv("../data/raw/cleaned/PATIENTS_clean.csv", stringsAsFactors = TRUE) %>%
  mutate(across(c(SUBJECT_ID, EXPIRE_FLAG), as.factor)) %>%
  filter(AGE_AT_ADMISSION > 0)

# Create a vector of SUBJECT_IDs where age > 0
subject_ids_adults <- patients$SUBJECT_ID

# Read the ADMISSIONS dataset and filter using the SUBJECT_ID vector
admissions <- read.csv("../data/raw/cleaned/ADMISSIONS_clean.csv", stringsAsFactors = TRUE) %>%
  filter(SUBJECT_ID %in% subject_ids_adults) %>% # Filter for adult patients 
  mutate(across(c(SUBJECT_ID, HADM_ID, SUBJECT_ID_COMPOSE), as.factor))

# Read the ICUSTAYS dataset and filter using the SUBJECT_ID vector
icu_stays <- read.csv("../data/raw/cleaned/ICUSTAYS_clean.csv", stringsAsFactors = TRUE) %>%
  filter(SUBJECT_ID %in% subject_ids_adults) %>%  # Filter for adult patients
  mutate(across(c(SUBJECT_ID, HADM_ID, ICUSTAY_ID), as.factor)) 
```

## 1.2. Desriptive Statistics and Visualisation Analysis

### 1.2.1. Outcome 1: Death Status

```{r descriptive statistics for death status}
# Death status outcome
Death_status_outcome <- admissions %>%
  select(SUBJECT_ID, SUBJECT_ID_COMPOSE, SURVIVAL_FLAG)

admissions %>%
  select(SURVIVAL_FLAG) %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "Value") %>%
  group_by(Variable, Value) %>%
  summarise(n = n(), .groups = 'drop') %>%
  group_by(Variable) %>%
  mutate(`No data` = sum(is.na(Value)),
         `% by group` = (n / sum(n)) * 100) %>%
  ungroup() %>%
  select(Variable, Value, n, `% by group`, `No data`) %>%
  arrange(Variable, Value) %>%
  flextable() %>%
  merge_v("Variable") %>%
  autofit() %>%
  border_inner(border = fp_border(color = "black", width = 1)) %>%
  border_outer(border = fp_border(color = "black", width = 1))
```

```{r barplot for death status}
# Visualization for EXPIRE_FLAG in admissions dataset
ggplot(admissions, aes(x = as.factor(SURVIVAL_FLAG), fill = as.factor(SURVIVAL_FLAG))) +
  geom_bar(color = "black") +
  geom_text(
          stat = "count", aes(label = after_stat(count)),
            size = 3, 
            fontface = "bold", 
            vjust = -0.5
    ) +
  scale_fill_manual(
    values = sample(color_palette, size = length(unique(admissions$SURVIVAL_FLAG)), replace = FALSE),
    labels = c("0" = "Not Dead", "1" = "Dead")
    ) +
  labs(
    title = "Distribution of Death Status", x = "Death Status", y = "Count", fill = "Death Status"
    ) +
  theme_custom

```

-   There were 45,007 ICU stays when patient did not die (labeled "Not Dead").
-   There were 5,735 ICU stays when patient died (labeled "Dead").

This indicates that a higher proportion of patients in the dataset survived compared to those who did not. 

### 1.2.2. Outcome 2: Length of Survival

```{r descriptive statistics for length of survival}
# Create Survival_outcome file whith unique SUBJECT_ID and summarise SURVIVAL
Survival_outcome <- admissions %>%
  select(SURVIVAL, SURVIVAL_FLAG, SUBJECT_ID, SUBJECT_ID_COMPOSE)

Survival_outcome %>%
  select(SURVIVAL) %>%
  summarise(across(everything(), statistics)) %>%
  pivot_longer(cols = everything(), names_sep = "__", names_to = c("Variable", "Stat")) %>%
  rename(`Value` = value) %>%
  flextable() %>%
  merge_v("Variable") %>%
  width(j = c("Variable", "Stat", "Value"), width = 2) %>%
  autofit() %>%
  border_inner(border = fp_border(color = "black", width = 1)) %>%
  border_outer(border = fp_border(color = "black", width = 1))
```

**Outliers Check**

``` {r outliers check for length of survival}
# Calculate mean and standard deviation
mean_value <- mean(Survival_outcome$SURVIVAL, na.rm = TRUE)
sd_value <- sd(Survival_outcome$SURVIVAL, na.rm = TRUE)

# Define the 3-sigma range
lower_bound <- mean_value - 3 * sd_value
upper_bound <- mean_value + 3 * sd_value

# Identify outliers
outliers <- Survival_outcome %>%
  filter(SURVIVAL < lower_bound | SURVIVAL > upper_bound)

# Calculate the number and percentage of outliers
num_outliers <- nrow(outliers)
total_values <- nrow(Survival_outcome)
percent_outliers <- (num_outliers / total_values) * 100

# Print the number and percentage of outliers
cat("Number of outliers:", num_outliers, "\n")
cat("Percentage of outliers:", round(percent_outliers, 2), "%\n")

# Filter out the outliers
Survival_outcome <- Survival_outcome %>%
  filter(SURVIVAL >= lower_bound & SURVIVAL <= upper_bound)

# Clean the memory
rm(outliers, mean_value, sd_value, lower_bound, upper_bound, num_outliers, percent_outliers, total_values)
```

Based on the small percentage of outliers observed, it was decided to filter them out. These outliers could potentially represent patients who were in a prolonged coma or had unusually extended hospital stays.

```{r boxplot for length of survival}
# Boxplot for TIMETODEATH
ggplot(Survival_outcome, aes(y = SURVIVAL)) +
  geom_boxplot(fill = color_palette[4], color = "black") +
  labs(title = "Boxplot of Time to Death (in Days)",
       y = "Time to Death (in days)") +
  theme_custom

```

```{r density plot for length of survival}
ggplot(Survival_outcome, aes(x = SURVIVAL)) +
  geom_density(fill = color_palette[14], alpha = 0.7) +
  labs(title = "Density Plot of Time to Death (in Days)",
       x = "Time to Death (in days)",
       y = "Density") +
  theme_custom
```

The boxplot and density plot show that most patients died within 0 to 10 days, with a median around 7 days. There are still several outliers, indicating some patients survived much longer, possibly due to unique conditions such as prolonged illness or coma.

### 1.2.3. Outcome 3: Length of ICU Stay

```{r descriptive statistics for length of ICU stay}
# LOS outcome
LOS_outcome <- icu_stays %>%
  select(SUBJECT_ID, SUBJECT_ID_COMPOSE, ICUSTAY_ID, LOS)

icu_stays %>%
  select(LOS) %>%
  summarise(across(everything(), statistics)) %>%
  pivot_longer(cols = everything(), names_sep = "__", names_to = c("Variable", "Stat")) %>%
  rename(`Value` = value) %>%
  flextable() %>%
  merge_v("Variable") %>%
  width(j = c("Variable", "Stat", "Value"), width = 2) %>%
  autofit() %>%
  border_inner(border = fp_border(color = "black", width = 1)) %>%
  border_outer(border = fp_border(color = "black", width = 1))
```

**Check for outliers**

```{r check for outliers for length of ICU stay}
# Calculate mean and standard deviation for LOS variable
mean_los <- mean(LOS_outcome$LOS, na.rm = TRUE)
sd_los <- sd(LOS_outcome$LOS, na.rm = TRUE)

# Identify outliers using the 3-sigma rule
LOS_outcome$outlier_los <- ifelse(
  LOS_outcome$LOS > (mean_los + 3 * sd_los) | LOS_outcome$LOS < (mean_los - 3 * sd_los),
  TRUE, 
  FALSE
)

# Count the number and percentage of outliers
num_outliers_los <- sum(LOS_outcome$outlier_los, na.rm = TRUE)
percent_outliers_los <- (num_outliers_los / nrow(LOS_outcome)) * 100

# Print results
cat("Number of outliers in LOS:", num_outliers_los, "\n")
cat("Percentage of outliers in LOS:", round(percent_outliers_los, 2), "%\n")

# Filter out the outliers
LOS_outcome <- LOS_outcome %>%
  select(LOS, SUBJECT_ID, SUBJECT_ID_COMPOSE, ICUSTAY_ID, outlier_los) %>%
  filter(outlier_los == FALSE)

# Drop the outlier column after filtering
LOS_outcome$outlier_los <- NULL

# Clean the memory
rm(mean_los, sd_los, num_outliers_los, percent_outliers_los)

```

Based on the relatively small percentage of outliers (2.29%), it was decided to filter them out from the icu_stays dataset. This filtering helps ensure a more robust analysis by excluding extreme cases that could disproportionately impact the results. It's worth noting that some of these outliers could represent unique cases, such as patients in a coma or those with extended ICU stays due to complex medical conditions.

```{r violin plot for length of ICU stay}
ggplot(LOS_outcome, aes(x = "", y = LOS)) +
  geom_violin(fill = color_palette[10], color = "black") +
  geom_boxplot(width = 0.1, fill = "white", outlier.shape = NA) +
  labs(title = "Violin Plot of Length of ICU Stay (LOS)",
       y = "Length of ICU Stay (Days)",
       x = "") +
  theme_custom

```

This plot highlights that most patients had shorter ICU stays, but there are a few cases with extended durations that could represent unique medical conditions or complications.

# 2. Patients Data

## 2.1. Read and Prepare Data

```{r read file patients}
patients <- patients %>%
  mutate(
    DOB = as.POSIXct(DOB, format = "%Y-%m-%d"),
    DOD = as.POSIXct(DOD, format = "%Y-%m-%d")
  ) %>%
  filter(SUBJECT_ID %in% subject_ids_adults) # Filter for adult patients 

skimr::skim(patients %>% select(-ROW_ID, -SUBJECT_ID))
```

## 2.2. Desriptive Statistics

### 2.2.1. Descriptive Statistics for Numerical Variables (Patient data)

```{r descriptive statistics for numerical vars}
# Summarize the statistics for each numeric variable
patients %>%
  select(-ROW_ID, -SUBJECT_ID, -EXPIRE_FLAG) %>%
  select(where(is.numeric)) %>% 
  summarise(across(everything(), statistics)) %>%
  pivot_longer(cols = everything(), names_sep = "__", names_to = c("Variable", "Stat")) %>%
  rename(`Value` = value) %>%
  flextable() %>%
  merge_v("Variable") %>%
  width(j = c("Variable", "Stat", "Value"), width = 2) %>%
  autofit() %>%
  border_inner(border = fp_border(color = "black", width = 1)) %>%
  border_outer(border = fp_border(color = "black", width = 1))
```

### 2.2.2. Descriptive Statistics for Categorical Variables (Patient data)

```{r Descriptive statistics patients for categorical vars}
# Clean and summarize the categorical data for all factor variables
patients %>%
  select(-DOB, -DOD, -SUBJECT_ID, -EXPIRE_FLAG) %>%
  select(where(is.factor)) %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "Value") %>%
  group_by(Variable, Value) %>%
  summarise(n = n(), .groups = 'drop') %>%
  group_by(Variable) %>%
  mutate(`No data` = sum(is.na(Value)),
         `% by group` = (n / sum(n)) * 100) %>%
  ungroup() %>%
  select(Variable, Value, n, `% by group`, `No data`) %>%
  arrange(Variable, Value) %>%
  flextable() %>%
  merge_v("Variable") %>%
  autofit() %>%
  border_inner(border = fp_border(color = "black", width = 1)) %>%
  border_outer(border = fp_border(color = "black", width = 1))
```

## 2.3. Visualisation Analysis by Outcome

### 2.3.1. Outcome 1: Death Status by Patients Data

```{r death status by gender}
patients_death_status <- Death_status_outcome %>%
  left_join(patients, by = "SUBJECT_ID") %>%
  select(SUBJECT_ID, AGE_AT_ADMISSION, GENDER, SURVIVAL_FLAG) %>%
  distinct() %>%
  mutate(SURVIVAL_FLAG = as.factor(SURVIVAL_FLAG))  # Convert to factor

ggplot(patients_death_status, aes(x = GENDER, fill = SURVIVAL_FLAG)) +
  geom_bar(position = position_dodge2(width = 0.9), color = "black") +
  geom_text(
    stat = 'count', aes(label = after_stat(count)),
    position = position_dodge2(width = 0.9), vjust = -0.5
  ) +
  scale_fill_manual(
    values = sample(color_palette, size = length(unique(patients_death_status$SURVIVAL_FLAG)), replace = FALSE),
    labels = c("0" = "Survive", "1" = "Died")
  ) +
  labs(
    title = "Death Status by Gender",
    x = "Gender",
    y = "Count",
    fill = "Death Status"
  ) +
  theme_custom 
```

-   Males (M) have a higher count in both survival (19,569) and death (3,068) categories compared to females.
-   Females (F) have a lower count, with 14,707 surviving and 2,652 deceased.

This suggests that while the total number of male patients is higher, the proportion of deceased individuals appears similar across genders.

```{r death status by age at admission}
ggplot(patients_death_status, aes(x = AGE_AT_ADMISSION, fill = SURVIVAL_FLAG)) +
  geom_histogram(binwidth = 5, alpha = 0.6, position = "identity", color = "black") +
  scale_fill_manual(
    values = sample(color_palette, size = length(unique(patients_death_status$SURVIVAL_FLAG))), 
    labels = c("0" = "Survive", "1" = "Died")
    ) +
  labs(title = "Death Status by Age at Admission", 
       x = "Age at Admission", 
       y = "Count", 
       fill = "Death Status") +
  theme_custom
```

The histogram shows that most patients are admitted between 50–80 years, with survival dominating across all ages. However, the proportion of deaths increases with age, especially after 75, indicating that older patients are more likely to die. Age is clearly a key factor influencing mortality.

During the exploratory data analysis, a significant spike in admissions for newborns (age 0) was observed, with the vast majority of these infants being alive. After careful consideration, it was decided to exclude the data for newborns (age 0) from our analysis.

**Rationale for Removal:**
1. Different Health Dynamics in Newborns

Newborns (age 0) have distinct health characteristics and mortality patterns compared to older children and adults. Their admissions are often related to birth-related complications, immediate post-birth care, or congenital conditions. These factors may not be directly relevant to the survival analysis intended for the rest of the population.
The survival dynamics for newborns are very different from those for older children or adults, making it difficult to generalize survival factors across the age spectrum when newborns are included.

2. Survival Bias in Newborns

The vast majority of newborns survive, which introduces a potential survival bias into the analysis. Since survival outcomes for newborns are typically skewed toward "alive" (due to medical advances in neonatal care), their inclusion could dilute the significance of other age groups and make it harder to detect meaningful survival trends.
Including newborns could potentially lead to misleading conclusions about the effect of age on survival outcomes, as the survival rate for age 0 is much higher compared to other age groups, thus overshadowing the variability observed in older patients.
Distortion of Survival Model Results:

The presence of a large proportion of patients who survive (newborns) can distort the results of a survival analysis. If survival outcomes for newborns (age 0) are predominantly "alive," they can skew the overall survival curve, potentially masking or distorting the real relationship between age and survival in older populations.
By excluding newborns, we ensure that the survival analysis reflects more accurate and relevant survival patterns across the broader population, without the confounding effect of newborn health outcomes.

### 2.3.2. Outcome 2: Length of Survival by Patients Data

```{r length of survival by age and gender}
# Merge admissions with patients data to include AGE_AT_ADMISSION
patients_survival_outcome <- Survival_outcome %>%
  left_join(patients, by = "SUBJECT_ID") %>%
  select(SUBJECT_ID, AGE_AT_ADMISSION, GENDER, SURVIVAL_FLAG, SURVIVAL) %>%
  distinct() %>%
  mutate(SURVIVAL_FLAG = as.factor(SURVIVAL_FLAG))  # Convert to factor

ggplot(patients_survival_outcome, aes(x = AGE_AT_ADMISSION, y = SURVIVAL, color = GENDER)) +
  geom_point(alpha = 0.7, size = 2, shape = 16, stroke = 0.3) +  # Scatter points
  geom_smooth(method = "lm", se = TRUE, size = 1, linetype = "solid", alpha = 0.2, colour = "grey40") +  # Add linear regression line
  labs(
    title = "Length of Survival by Age",
    x = "Age at Admission",
    y = "Time to Death (Days)",
    color = "Gender"
  ) +
  scale_color_manual(
    values = sample(color_palette, size = length(unique(patients_survival_outcome$GENDER)), replace = FALSE)
  ) +
  theme_custom +
  theme(
    panel.grid.major = element_line(color = "grey90", size = 0.5),
    legend.position = "right"
  )

# Create a new age group column based on quintiles
age_breaks <- quantile(patients_survival_outcome$AGE_AT_ADMISSION, probs = seq(0, 1, 0.2), na.rm = TRUE)
age_labels <- paste0("(", round(head(age_breaks, -1)), "-", round(tail(age_breaks, -1)), "]")

patients_survival_outcome <- patients_survival_outcome %>%
  mutate(AGE_QUINTILE = cut(AGE_AT_ADMISSION, 
                            breaks = age_breaks,
                            include.lowest = TRUE,
                            labels = age_labels))

# Plot including age quintiles as facets
ggplot(patients_survival_outcome, aes(x = GENDER, y = SURVIVAL, fill = GENDER)) +
  geom_boxplot() +
  facet_wrap(~ AGE_QUINTILE, ncol = 3) +  # Facet by age quintiles
  labs(title = "Length of Survival by Gender and Age Quintile",
       x = "Gender",
       y = "Time to Death (Days)") +
  scale_fill_manual(values = sample(color_palette, size = length(unique(patients_survival_outcome$GENDER)))) +
  theme_custom

ggplot(patients_survival_outcome, aes(x = SURVIVAL, y = as.factor(AGE_QUINTILE), fill = GENDER, color = GENDER)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.7, position = position_dodge2(preserve = "single")) +
  geom_jitter(width = 0.2, alpha = 0.5, size = 1.5) +
  facet_wrap(~GENDER, scales = "free_y") +
  scale_fill_manual(values = sample(color_palette, size = length(unique(patients_survival_outcome$GENDER)), replace = FALSE)) +
  scale_color_manual(values = sample(color_palette, size = length(unique(patients_survival_outcome$GENDER)), replace = FALSE)) +
  labs(
    title = "Time to Death by Age Quintile for Males and Females",
    y = "Age Quintile",
    x = "Time to Death (Days)",
    fill = "Gender",
    color = "Gender"
  ) +
  theme_custom +
  theme(
    legend.position = "right",
    strip.text = element_text(size = 12, face = "bold")
  )

rm(age_breaks, age_labels)

```

The plots allow for the visualization of how gender and age interact to influence survival times.

*Scatter Plot: Length of Survival by Age*

- No clear correlation between age at admission and time to death. Survival time is distributed across all age groups.
- Both male and female distributions appear similar, with no noticeable trend favoring one gender.

*Faceted Scatter Plot: Time to Death by Age Quintile and Gender*

- Age Quintiles: Older age groups (e.g., 80-93) show slightly higher clustering of shorter survival times.
- Within each age group, survival patterns for males and females are similar, indicating no strong gender-based differences in survival outcomes.

### 2.3.3. Outcome 3: Length of ICU Stay by Patients Data

```{r length of ICU stay by gender and age}
# Merge icu_stays with patients data to include AGE_AT_ADMISSION
patients_los_outcome <- LOS_outcome %>%
  left_join(patients, by = "SUBJECT_ID") %>%
  select(SUBJECT_ID, SUBJECT_ID_COMPOSE, LOS, AGE_AT_ADMISSION, GENDER)

ggplot(patients_los_outcome, aes(x = AGE_AT_ADMISSION, y = LOS, color = GENDER)) +
  geom_point(alpha = 0.7, size = 2, shape = 16, stroke = 0.3) +  # Scatter points
  geom_smooth(method = "lm", se = TRUE, size = 1, linetype = "solid", alpha = 0.2, colour = "grey40") +  # Add linear regression line
  labs(
    title = "Length of Stay (LOS) by by Age",
    x = "Age at Admission",
    y = "Length of Stay (Days)",
    color = "Gender"
  ) +
  scale_color_manual(
    values = sample(color_palette, size = length(unique(patients_los_outcome$GENDER)), replace = FALSE)
  ) +
  theme_custom +
  theme(
    panel.grid.major = element_line(color = "grey90", size = 0.5),
    legend.position = "right"
  )

# Create a new age group column based on quintiles
age_breaks_los <- quantile(patients_los_outcome$AGE_AT_ADMISSION, probs = seq(0, 1, 0.2), na.rm = TRUE)
age_labels_los <- paste0("(", round(head(age_breaks_los, -1)), "-", round(tail(age_breaks_los, -1)), "]")

patients_los_outcome <- patients_los_outcome %>%
  mutate(AGE_QUINTILE = cut(AGE_AT_ADMISSION, 
                             breaks = age_breaks_los,
                             include.lowest = TRUE,
                             labels = age_labels_los))

# Plot including age quintiles as facets for Length of Stay (LOS)
ggplot(patients_los_outcome, aes(x = GENDER, y = LOS, fill = GENDER)) +
  geom_boxplot() +
  facet_wrap(~ AGE_QUINTILE, ncol = 3) +
  labs(title = "Length of Stay (LOS) by Gender and Age Quintile",
       x = "Gender",
       y = "Length of Stay (Days)") +
  scale_fill_manual(values = sample(color_palette, size = length(unique(patients_los_outcome$GENDER)))) +
  theme_custom

rm(age_breaks_los, age_labels_los)
```

There is no strong trend indicating that age at admission directly correlates with the length of Stay (Days).
Gender Difference: Both genders (F and M) show similar distributions of length of Stay (Days) across all ages.

## 2.4. Exploratory analysis

### 2.4.1. Outcome 1: Death Status by Patients Data

```{r Death Status by Patients Data Exploratory analysis}
# Perform the statistical tests for both variables
result_age <- perform_statistical_tests(patients_death_status, "SURVIVAL_FLAG", "AGE_AT_ADMISSION", "Age")
result_sex <- perform_statistical_tests(patients_death_status, "SURVIVAL_FLAG", "GENDER", "Gender")

# Merge the results
merged_results <- bind_rows(result_age, result_sex)

print(merged_results)

rm(patients_death_status, result_age, result_sex, merged_results)
```

*Age:* The Mann-Whitney U Test result (< 0.0001) indicates a significant difference in death status based on age.
*Gender:* The Chi-Squared Test result (0.0005) shows a significant association between gender and death status.

Both **Age and Gender** show highly significant associations with death status (SURVIVAL_FLAG), suggesting they are both important variables in explaining survival outcomes in this dataset.

### 2.4.2. Outcome 2: Length of Survival by Patients Data

```{r Length of Survival by Patients DataExploratory analysis}
patients_survival_outcome <- patients_survival_outcome %>%
  mutate(
    SURVIVAL_FLAG = as.numeric(SURVIVAL_FLAG)
  )
  
# Generate Kaplan-Meier survival curve by GENDER
fit_gender <- survfit(Surv(SURVIVAL, SURVIVAL_FLAG) ~ GENDER, data = patients_survival_outcome)

# Plot the Kaplan-Meier curve
ggsurvplot(
  fit_gender,
  data = patients_survival_outcome,
  pval = TRUE,  # Display p-value for age groups
  conf.int = TRUE,  # Add confidence intervals
  ggtheme = theme_custom,
  surv.median.line = "hv",
  legend.title = "Age Group",
  title = "Survival Curve by Age Group",
  palette = color_palette
)

# Create age groups based on AGE_AT_ADMISSION
patients_survival_outcome <- patients_survival_outcome %>%
  mutate(
    AGE_GROUP = cut(AGE_AT_ADMISSION,
                    breaks = c(0, 18, 40, 60, 100), 
                    labels = c("0-18", "19-40", "41-60", "61+"),
                    right = FALSE)  # Include the left boundary in each group
  )

# Fit the Kaplan-Meier survival curve by age group
fit_age_group <- survfit(Surv(SURVIVAL, SURVIVAL_FLAG) ~ AGE_GROUP, data = patients_survival_outcome)

# Plot the Kaplan-Meier curve for the age groups
ggsurvplot(
  fit_age_group,
  data = patients_survival_outcome,
  pval = TRUE,  # Display p-value for age groups
  conf.int = TRUE,  # Add confidence intervals
  ggtheme = theme_custom,
  surv.median.line = "hv",
  legend.title = "Age Group",
  title = "Survival Curve by Age Group",
  palette = color_palette
)

hr_table <- HR_assessment("SURVIVAL", "SURVIVAL_FLAG", c("GENDER", "AGE_AT_ADMISSION"), patients_survival_outcome)

print(hr_table)

rm(hr_table, fit_age_group, fit_gender, patients_survival_outcome)
```

*Age at Admission:* This factor has a strong and highly significant association with mortality (p < 0.0001). Its hazard ratio (HR = 1.026) indicates that the risk of death increases with age, making it a crucial variable for predictive models.

*Gender:* Although statistically significant (p = 0.0128), the hazard ratio (HR = 0.935) suggests a small effect size. You could include gender in the model, especially if other analyses or prior knowledge suggest its importance as a confounder or interacting variable.

### 2.4.3. Outcome 3: Length of ICU Stay by Patients Data

``` {r Length of ICU Stay by Patients Data}

result_age <- analyze_predictor_LOS(patients_los_outcome, predictor = "AGE_AT_ADMISSION", LOS = "LOS", patient_id = "SUBJECT_ID")
result_sex <- analyze_predictor_LOS(patients_los_outcome, predictor = "GENDER", LOS = "LOS", patient_id = "SUBJECT_ID")

# Merge the results
merged_results <- bind_rows(result_age, result_sex)
print(merged_results)

rm(patients, merged_results, result_age, result_sex, patients_los_outcome)
```

*Age at Admission:*

- The mixed-effects linear model indicates a significant association between Age at Admission and Length of Stay in ICU (p < 0.0001).
- The positive coefficient (Statistic = 0.0053) suggests that older patients tend to have slightly longer ICU stays.

*Gender:*

- The model does not show a significant association between Gender and Length of Stay in ICU (p = 0.6624).
- This indicates that gender is unlikely to influence ICU stay duration in this dataset.

# 3. Admissions Data

## 3.1. Read and Prepare Data

```{r read file}
skimr::skim(admissions %>%
              select(-HADM_ID, -SUBJECT_ID, -SUBJECT_ID_COMPOSE) %>%
            mutate(
              SURVIVAL_FLAG = as.factor(SURVIVAL_FLAG)
            ))
```

## 3.2. Desriptive statistics

### 3.2.1. Descriptive statistics for categorical variables (Admission data)

```{r descriptive statistica admissions}
# Clean and summarize the categorical data for all factor variables
admissions %>%
  select(ADMISSION_TYPE, INSURANCE, RELIGION, MARITAL_STATUS, ETHNICITY) %>%
  select(where(is.factor)) %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "Value") %>%
  group_by(Variable, Value) %>%
  summarise(n = n(), .groups = 'drop') %>%
  group_by(Variable) %>%
  mutate(`No data` = sum(is.na(Value)),
         `% by group` = (n / sum(n)) * 100) %>%
  ungroup() %>%
  select(Variable, Value, n, `% by group`, `No data`) %>%
  arrange(Variable, Value) %>%
  flextable() %>%
  merge_v("Variable") %>%
  autofit() %>%
  border_inner(border = fp_border(color = "black", width = 1)) %>%
  border_outer(border = fp_border(color = "black", width = 1))
```

## 3.3. Visualisation Analysis by Outcome
### 3.3.1. Outcome 1: Death Status by Admissions Data

```{r death status by admissions data}
admissions_death_outcome <- admissions %>%
  select(SURVIVAL_FLAG, ADMISSION_TYPE, INSURANCE, RELIGION, MARITAL_STATUS, ETHNICITY)

# Prepare the data for plotting
admissions_death_outcome_long <- admissions_death_outcome %>%
  pivot_longer(cols = -SURVIVAL_FLAG, names_to = "Variable", values_to = "Value")

# List of categorical variables to plot
categorical_vars <- c("ADMISSION_TYPE", "INSURANCE", "RELIGION", "MARITAL_STATUS", "ETHNICITY")

# Loop through each variable and create a bar plot
for (var in categorical_vars) {
  p <- ggplot(admissions_death_outcome_long[admissions_death_outcome_long$Variable == var, ], aes(x = Value, fill = as.factor(SURVIVAL_FLAG))) +
    geom_bar(position = "dodge2", color = "black") +
    geom_text(stat = "count", aes(label = after_stat(count)), 
              position = position_dodge(width = 0.9), 
              vjust = -0.5, size = 3) +  # Adjust label position and size
    labs(title = paste("Death Status by", var),
         x = "Category",
         y = "Count",
         fill = "Death Status") +
    theme_custom +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +  # Rotate x-axis labels
    scale_fill_manual(values = sample(color_palette, size = length(unique(admissions$SURVIVAL_FLAG))), labels = c("0" = "Survived", "1" = "Died"))
  
  # Print or save the plot
  print(p)
}

rm(p, categorical_vars, admissions_death_outcome_long)

```

*Admission Type:* Emergency admissions are associated with higher mortality, likely reflecting the severity of cases. Elective admissions, often planned and less acute, show lower death rates.

*Insurance:* Patients with Medicare, predominantly older individuals, have higher mortality, emphasizing age and associated comorbidities as risk factors.

*Religion:* Christianity and "Unknown" categories account for the majority of cases. This could reflect demographic prevalence in the population or limitations in data recording.

*Ethnicity:* White ethnicity dominates the data, with a notable survival rate but also the largest death count. Lower representation of other ethnicities may require further investigation for equity in care and outcomes.

### 3.3.2. Outcome 2: Length of Survival by Admissions Data

``` {r Outcome 2: Length of Survival by Admissions Data visualisation}
admissions_survival_outcome <- admissions %>%
  select(SUBJECT_ID_COMPOSE, SURVIVAL, SURVIVAL_FLAG, ADMISSION_TYPE, INSURANCE, RELIGION, MARITAL_STATUS, ETHNICITY) %>%
  mutate(SURVIVAL_FLAG = as.factor(SURVIVAL_FLAG))

# Function to create the plot
create_admission_plot <- function(data, x_var, color_var, color_palette, theme_custom) {
  ggplot(data, aes_string(x = x_var, y = "SURVIVAL", fill = x_var, color = color_var)) +
    geom_boxplot(outlier.shape = NA) +
    geom_jitter(width = 0.2, alpha = 0.7, fill = "white", shape = 21, size = 2, stroke = 0.5) +
    theme_custom +
    scale_fill_manual(values = color_palette) +
    scale_color_manual(values = c("black", "blue")) +
    labs(
      title = paste("Time to Death by", x_var),
      y = "Time to Death (Days)", x = x_var,
      color = "Survival Status"  # Add legend label
    ) +
    theme(
      legend.position = "right",  # Show the legend for SURVIVAL_FLAG
      strip.text = element_text(size = 12, face = "bold"),
      axis.text.x = element_text(angle = 45, hjust = 1)  # Rotate x-axis labels
    )
}

# Define the admission variables
admission_vars <- c("ADMISSION_TYPE", "INSURANCE", "MARITAL_STATUS", "ETHNICITY", "RELIGION")

# Create a list to store the plots
plots <- lapply(admission_vars, function(var) {
  create_admission_plot(admissions_survival_outcome, var, "SURVIVAL_FLAG", color_palette, theme_custom)
})

# Name the plots for easy reference
names(plots) <- admission_vars
for (var_name in names(plots)) {
  print(plots[[var_name]])
}

rm(plots, admission_vars, create_admission_plot, var_name, var)
``` 

Across these plots, admission type, insurance, and marital status appear to have significant influence on survival variability. These factors could be explored further in predictive modeling to understand their direct or indirect impact on survival outcomes. Ethnicity and religion may require more robust representation for conclusive insights.


### 3.3.3. Outcome 3: Length of ICU Stay by Admissions Data

``` {r Outcome 3: Length of ICU Stay by Admissions Data visualisation}
# Clean and prepare the data
admissions_los_outcome <- admissions %>%
  left_join(LOS_outcome, by = "SUBJECT_ID_COMPOSE") %>%
  select(SUBJECT_ID_COMPOSE, SURVIVAL, SURVIVAL_FLAG, ADMISSION_TYPE, INSURANCE, RELIGION, MARITAL_STATUS, ETHNICITY, LOS) %>%
  mutate(SURVIVAL_FLAG = as.factor(SURVIVAL_FLAG))

# Function to create the plot
create_LOS_plot <- function(data, x_var, color_var, color_palette, theme_custom) {
  ggplot(data, aes_string(x = x_var, y = "LOS", fill = x_var, color = color_var)) +
    geom_boxplot(outlier.shape = NA) +
    geom_jitter(width = 0.2, alpha = 0.4, fill = "white", shape = 21, size = 2, stroke = 0.5) +
    theme_custom +
    scale_fill_manual(values = color_palette) +
    scale_color_manual(values = c("black", "blue")) +
    labs(
      title = paste("Length of ICU Stay by", x_var),
      y = "Length of ICU Stay (Days)", x = x_var,
      color = "Survival Status"  # Add legend label
    ) +
    theme(
      legend.position = "right",  # Show the legend for SURVIVAL_FLAG
      strip.text = element_text(size = 12, face = "bold"),
      axis.text.x = element_text(angle = 45, hjust = 1)  # Rotate x-axis labels
    )
}

# Define the admission variables
admission_vars <- c("ADMISSION_TYPE", "INSURANCE", "MARITAL_STATUS", "ETHNICITY", "RELIGION")

# Create a list to store the plots
plots <- lapply(admission_vars, function(var) {
  create_LOS_plot(admissions_los_outcome, var, "SURVIVAL_FLAG", color_palette, theme_custom)
})

# Name the plots for easy reference
names(plots) <- admission_vars
for (var_name in names(plots)) {
  print(plots[[var_name]])
}

rm(plots, admission_vars, create_LOS_plot, var_name, var)
```

While categorical variables such as admission type, insurance, marital status, ethnicity, and religion show some variability in ICU stays, survival status does not appear to significantly impact the duration within these groups. The most substantial differences are seen in admission type and insurance categories, suggesting these factors could be explored further for ICU resource management or predictive modeling.

## 3.4. Exploratory analysis
### 3.4.1. Outcome 1: Death Status by Admissions Data

```{r Death Status by Admissions Data }
admissions_death_outcome <- admissions_death_outcome %>%
  mutate(
    SURVIVAL_FLAG = as.numeric(as.character(SURVIVAL_FLAG))  # Ensure EXPIRE_FLAG is numeric
  )

# Perform the statistical tests for both variables
admissions_death_outcome$ADMISSION_TYPE <- droplevels(admissions_death_outcome$ADMISSION_TYPE)

result_ADMISSION_TYPE <- perform_statistical_tests(admissions_death_outcome, "SURVIVAL_FLAG", "ADMISSION_TYPE", "ADMISSION TYPE")
result_INSURANCE <- perform_statistical_tests(admissions_death_outcome, "SURVIVAL_FLAG", "INSURANCE", "INSURANCE")
result_RELIGION <- perform_statistical_tests(admissions_death_outcome, "SURVIVAL_FLAG", "RELIGION", "RELIGION")
result_MARITAL_STATUS <- perform_statistical_tests(admissions_death_outcome, "SURVIVAL_FLAG", "MARITAL_STATUS", "MARITAL STATUS")
result_ETHNICITY <- perform_statistical_tests(admissions_death_outcome, "SURVIVAL_FLAG", "ETHNICITY", "ETHNICITY")

# Merge the results
merged_results <- bind_rows(result_ADMISSION_TYPE, result_INSURANCE, result_RELIGION, result_MARITAL_STATUS, result_ETHNICITY)

print(merged_results)

rm(result_ADMISSION_TYPE, result_ETHNICITY, result_INSURANCE, result_MARITAL_STATUS, result_RELIGION, merged_results, admissions_death_outcome)

```

All tested variables—Admission Type, Insurance, Religion, Marital Status, and Ethnicity—demonstrated statistically significant associations with death status in the Chi-Squared tests (p-value = 0.0005). This indicates that these variables may influence the likelihood of survival or death among patients.

Since all variables show significant associations with the outcome (death status), they are strong candidates for inclusion in predictive models for mortality risk.

### 3.4.2. Outcome 2: Length of Survival by Admissions Data

```{r Length of Survival by Admissions Data exploratory analysis}
admissions_survival_outcome <- admissions_survival_outcome %>%
  mutate(
    SURVIVAL_FLAG = as.numeric(as.character(SURVIVAL_FLAG))  # Ensure EXPIRE_FLAG is numeric
  )

admissions_survival_outcome$ADMISSION_TYPE <- droplevels(admissions_survival_outcome$ADMISSION_TYPE)

# Generate Kaplan-Meier survival curve by GENDER
fit_admission_type <- survfit(Surv(SURVIVAL, SURVIVAL_FLAG) ~ ADMISSION_TYPE, data = admissions_survival_outcome)

# Plot the Kaplan-Meier curve
ggsurvplot(
  fit_admission_type,
  data = admissions_survival_outcome,
  pval = TRUE,  # Display p-value for gender
  conf.int = TRUE,  # Add confidence intervals
  ggtheme = theme_custom,
  surv.median.line = "hv",
  legend.title = "Admission type",
  title = "Survival Curve by Admission Type",
  palette =  color_palette
)

# Generate Kaplan-Meier survival curve by GENDER
fit_insurance <- survfit(Surv(SURVIVAL, SURVIVAL_FLAG) ~ INSURANCE, data = admissions_survival_outcome)

# Plot the Kaplan-Meier curve 
ggsurvplot(
  fit_insurance,
  data = admissions_survival_outcome,
  pval = TRUE,  # Display p-value for age groups
  conf.int = TRUE,  # Add confidence intervals
  ggtheme = theme_custom,
  surv.median.line = "hv",
  legend.title = "Insurance",
  title = "Survival Curve by Insurance",
  palette = color_palette
)

# Fit Kaplan-Meier model
fit_religion <- survfit(Surv(SURVIVAL, SURVIVAL_FLAG) ~ RELIGION, data = admissions_survival_outcome)

# Plot the Kaplan-Meier curve
ggsurvplot(
  fit_religion,
  data = admissions_survival_outcome,
  pval = TRUE,  # Display p-value
  conf.int = TRUE,  # Add confidence intervals
  ggtheme = theme_custom,
  surv.median.line = "hv",
  legend.title = "Religion",
  title = "Survival Curve by Religion",
  palette = color_palette
)

# Fit Kaplan-Meier model
fit_marital_status <- survfit(Surv(SURVIVAL, SURVIVAL_FLAG) ~ MARITAL_STATUS, data = admissions_survival_outcome)

# Plot the Kaplan-Meier curve
ggsurvplot(
  fit_marital_status,
  data = admissions_survival_outcome,
  pval = TRUE,  # Display p-value
  conf.int = TRUE,  # Add confidence intervals
  ggtheme = theme_custom,
  surv.median.line = "hv",
  legend.title = "Marital Status",
  title = "Survival Curve by Marital Status",
  palette = color_palette
)

# Fit Kaplan-Meier model
fit_ethnicity <- survfit(Surv(SURVIVAL, SURVIVAL_FLAG) ~ ETHNICITY, data = admissions_survival_outcome)

# Plot the Kaplan-Meier curve
ggsurvplot(
  fit_ethnicity,
  data = admissions_survival_outcome,
  pval = TRUE,  # Display p-value
  conf.int = TRUE,  # Add confidence intervals
  ggtheme = theme_custom,
  surv.median.line = "hv",
  legend.title = "Ethnicity",
  title = "Survival Curve by Ethnicity",
  palette = color_palette
)

hr_table <- HR_assessment("SURVIVAL", "SURVIVAL_FLAG", c("ADMISSION_TYPE", "INSURANCE", "MARITAL_STATUS", "RELIGION", "ETHNICITY"), admissions_survival_outcome)

print(hr_table)

rm(admissions_survival_outcome, hr_table, fit_religion, fit_admission_type, fit_ethnicity, fit_insurance, fit_marital_status)

```

Variables with significant p-values (< 0.05), such as admission type, insurance type (except Medicaid), marital status, religion, and ethnicity, should be included in survival modeling as they demonstrate a clear relationship with the risk of death.

### 3.4.3. Outcome 3: Length of ICU Stay by Admissions Data

``` {r Length of ICU Stay by Admission Data}
admissions_los_outcome <- admissions_los_outcome %>%
  mutate(
    SURVIVAL_FLAG = as.numeric(as.character(SURVIVAL_FLAG))
  )
  
result_ADMISSION_TYPE <- analyze_predictor_LOS(admissions_los_outcome, predictor = "ADMISSION_TYPE", LOS = "LOS", patient_id = "SUBJECT_ID_COMPOSE")
result_INSURANCE <- analyze_predictor_LOS(admissions_los_outcome, predictor = "INSURANCE", LOS = "LOS", patient_id = "SUBJECT_ID_COMPOSE")
result_RELIGION <- analyze_predictor_LOS(admissions_los_outcome, predictor = "RELIGION", LOS = "LOS", patient_id = "SUBJECT_ID_COMPOSE")
result_MARITAL_STATUS <- analyze_predictor_LOS(admissions_los_outcome, predictor = "MARITAL_STATUS", LOS = "LOS", patient_id = "SUBJECT_ID_COMPOSE")
result_ETHNICITY <- analyze_predictor_LOS(admissions_los_outcome, predictor = "ETHNICITY", LOS = "LOS", patient_id = "SUBJECT_ID_COMPOSE")

# Merge the results
merged_results <- bind_rows(result_ADMISSION_TYPE, result_INSURANCE, result_RELIGION, result_MARITAL_STATUS, result_ETHNICITY)

print(merged_results)

rm(admissions, admissions_los_outcome, merged_results, result_RELIGION, result_MARITAL_STATUS, result_ADMISSION_TYPE, result_INSURANCE, result_ETHNICITY)
```

Significant predictors with p < 0.05, such as:
- Admission Type (Emergency, Urgent)
- Insurance (Medicare, Self Pay)
- Religion (Judaism, Unknown)

# 4.   Diagnoses Data
## 4.1.   Read Data

``` {r read data diagnoses}
diagnoses <- read.csv("../data/raw/cleaned/DIAGNOSES_ICD_clean.csv", stringsAsFactors = TRUE) %>%
  mutate(across(where(is.character), as.factor))  %>%
  filter(SUBJECT_ID %in% subject_ids_adults) %>%
  mutate(SUBJECT_ID = as.factor(SUBJECT_ID))

skimr::skim(diagnoses %>%
              select(-SUBJECT_ID, -SUBJECT_ID_COMPOSE, -ROW_ID))
```

## 4.2.   Descriptive Statistics
### 4.2.1. Descriptive statistics for numerical variables (Diagnoses)

```{r descriptive statistics for numerical vars (Diagnoses)}
# Summarize the statistics for each numeric variable
diagnoses %>%
  select(SUBJECT_ID_COMPOSE, DIAGNOSES_NUM) %>%
  distinct() %>% # one number for 1 patient
  select(DIAGNOSES_NUM) %>%
  summarise(across(everything(), statistics)) %>%
  pivot_longer(cols = everything(), names_sep = "__", names_to = c("Variable", "Stat")) %>%
  rename(`Value` = value) %>%
  flextable() %>%
  merge_v("Variable") %>%
  width(j = c("Variable", "Stat", "Value"), width = 2) %>%
  autofit() %>%
  border_inner(border = fp_border(color = "black", width = 1)) %>%
  border_outer(border = fp_border(color = "black", width = 1))
```

### 4.2.2. Descriptive statistics for categorical variables (Diagnoses)

```{r Descriptive statistics patients for categorical vars (Diagnoses)}
# Clean and summarize the categorical data for all factor variables
diagnoses %>%
  filter(SEQ_NUM == 1) %>%
  select(where(is.factor), -SHORT_TITLE, -ICD9_CODE) %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "Value") %>%
  group_by(Variable, Value) %>%
  summarise(n = n(), .groups = 'drop') %>%
  group_by(Variable) %>%
  mutate(`No data` = sum(is.na(Value)),
         `% by group` = (n / sum(n)) * 100) %>%
  ungroup() %>%
  filter(n >= 100) %>% # Keep only rows with at least 1000 observations
  select(Variable, Value, n, `% by group`, `No data`) %>%
  arrange(Variable, desc(n), Value) %>% # Sort by Variable and descending frequency (n)
  flextable() %>%
  merge_v("Variable") %>%
  autofit() %>%
  border_inner(border = fp_border(color = "black", width = 1)) %>%
  border_outer(border = fp_border(color = "black", width = 1))

```

## 4.3. Visualisation Analysis by Outcome

### 4.3.1. Outcome 1: Death Status by Diagnoses

``` {r Death Status by Diagnoses}
# Visualize how distributes diagnoses with high-priority diagnosis
high_priority <- diagnoses %>%
  filter(SEQ_NUM == 1) %>%
  count(LONG_TITLE, sort = TRUE) %>%
  mutate(Percentage = n / sum(n) * 100,
         Cumulative_Percentage = cumsum(Percentage)) %>%
  filter(Cumulative_Percentage <= 35) # Keep diagnoses contributing to top 30%

ggplot(high_priority, aes(x = reorder(LONG_TITLE, -n), y = n)) +
  geom_bar(stat = "identity", fill = color_palette[6], color = "black") +
  geom_text(aes(label = n), hjust = 1.2, size = 3) +
  labs(title = "High-Priority Diagnoses (contributing to top 35%)",
       x = "ICD9 Code",
       y = "Frequency") +
  theme_custom +
  coord_flip() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Visualize how many diagnoses (DIAGNOSES_NUM unique number for each patients) has patients who died and who not 

diagnoses_death_outcome <- Death_status_outcome %>%
  left_join(diagnoses, by = "SUBJECT_ID_COMPOSE") %>%
  select(SUBJECT_ID_COMPOSE, SURVIVAL_FLAG, LONG_TITLE, SEQ_NUM, DIAGNOSES_NUM)

# Simplified dataset: Ensure DIAGNOSES_NUM is directly used
diagnoses_death_summary <- diagnoses_death_outcome %>%
  group_by(SURVIVAL_FLAG) %>%
  summarise(
    Mean_Diagnoses = mean(DIAGNOSES_NUM, na.rm = TRUE),
    Median_Diagnoses = median(DIAGNOSES_NUM, na.rm = TRUE),
    Count = n(),
    .groups = "drop"
  )

# Bar plot: Average number of diagnoses by death status
ggplot(diagnoses_death_summary, aes(x = factor(SURVIVAL_FLAG), y = Mean_Diagnoses, fill = factor(SURVIVAL_FLAG))) +
  geom_bar(stat = "identity", position = "dodge", width = 0.6, color = "black") +
  geom_text(aes(label = round(Mean_Diagnoses, 1)), vjust = -0.5, size = 3) +
  labs(title = "Mean Number of Diagnoses by Death Status",
       x = "Death Status (0 = Survived, 1 = Died)",
       y = "Mean Number of Diagnoses",
       fill = "Death Status") +
  scale_fill_manual(values = sample(color_palette, size = length(unique(diagnoses_death_summary$SURVIVAL_FLAG)), replace = FALSE), labels = c("0" = "Not Dead", "1" = "Dead")) +
  theme_custom +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5))

rm(high_priority, diagnoses_death_summary)
```

The bar chart highlights the most frequently occurring diagnoses contributing to adverse outcomes or higher mortality. The top diagnosis, "Coronary atherosclerosis of native coronary artery," appears 3496 times, indicating a significant health concern.

Other critical conditions such as "Unspecified septicemia" (2064 instances) and "Subendocardial infarction, initial episode of care" (1750 instances) also prominently feature, showing their relevance in critical care settings.

Patients who died had a higher mean number of diagnoses (18.4) compared to those who survived (16.7).
This indicates a potential association between the complexity of a patient's medical history (measured by the number of diagnoses) and mortality.

### 4.3.2. Outcome 2: Length of Survival by Diagnoses

```{r length of survival by diagnoses}
# Merge admissions and high-priority diagnoses
top_diagnoses <- diagnoses %>%
  filter(SEQ_NUM == 1) %>%
  count(LONG_TITLE, sort = TRUE) %>%
  mutate(Percentage = n / sum(n) * 100,
         Cumulative_Percentage = cumsum(Percentage)) %>%
  filter(Cumulative_Percentage <= 35) %>%
  select(LONG_TITLE)

# Join with survival_outcome to retain survival data
diagnoses_admissions_high_priority <- Survival_outcome %>%
  left_join(diagnoses, by = "SUBJECT_ID_COMPOSE") %>% 
  filter(SEQ_NUM == 1, LONG_TITLE %in% top_diagnoses$LONG_TITLE)

# Plot: High-priority diagnosis by SURVIVAL length
ggplot(diagnoses_admissions_high_priority, aes(x = LONG_TITLE, y = SURVIVAL, fill = LONG_TITLE, color = as.factor(SURVIVAL_FLAG))) +
  geom_boxplot(outlier.shape = NA, alpha = 0.7) +
  geom_jitter(width = 0.2, alpha = 0.5, fill = "white", shape = 21, size = 2, stroke = 0.5) +
  labs(title = "High-Priority Diagnoses by Survival Length",
       x = "High-Priority Diagnosis",
       y = "Survival Length (Days)") +
  scale_fill_manual(values = color_palette) +
  scale_color_manual(values = color_palette) +
  theme_custom +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1)
    )

# Merge admissions and diagnoses
diagnoses_survival_outcome <- Survival_outcome %>%
  left_join(diagnoses, by = "SUBJECT_ID_COMPOSE") %>%
  select(SUBJECT_ID_COMPOSE, SURVIVAL, LONG_TITLE, SEQ_NUM, DIAGNOSES_NUM)

# Plot: Average number of diagnoses per patient by survival length
diagnoses_survival_outcome %>%
  group_by(SURVIVAL) %>%
  summarise(Average_Diagnoses = mean(DIAGNOSES_NUM, na.rm = TRUE), .groups = "drop") %>%
  ggplot(aes(x = SURVIVAL, y = Average_Diagnoses)) +
  geom_line(color = color_palette[10], size = 1.2) +  # Line for trend
  geom_point(color = color_palette[22], fill = "white", shape = 21, size = 2, stroke = 0.5) +  # Dots with outline
  geom_smooth(method = "loess", color = "darkblue", fill = "blue", alpha = 0.2, size = 1, se = TRUE) +  # LOESS smooth trend
  labs(
    title = "Average Number of Diagnoses by Survival Length",
    x = "Survival Length (Days)",
    y = "Average Number of Diagnoses"
  ) +
  scale_x_continuous(limits = c(0, max(diagnoses_survival_outcome$SURVIVAL, na.rm = TRUE)), expand = c(0, 0)) + 
  scale_y_continuous(expand = c(0, 0)) + 
  theme_custom +
  theme(
    panel.grid.major = element_line(color = "grey40", size = 0.5),  # Add gridlines
    panel.grid.minor = element_line(color = "grey95", size = 0.25)
  )

rm(top_diagnoses, diagnoses_admissions_high_priority)

```

Most diagnoses exhibit a central clustering of survival lengths around the median, indicating a similar distribution of survival days for many conditions.

Some outliers indicate that specific diagnoses could have prolonged or extremely short survival outcomes.

Diagnoses like "Unspecified septicemia" and "Coronary atherosclerosis of native coronary artery" appear frequently and may require further exploration for modeling.
Average Number of Diagnoses by Survival Length:

There is an observable upward trend, indicating that a higher survival length corresponds with an increased number of diagnoses.

This suggests a potential relationship where prolonged hospital stays or complex medical conditions (resulting in multiple diagnoses) are associated with extended survival durations.
These insights highlight the importance of including high-priority diagnoses and the number of diagnoses in survival modeling, as they seem to provide significant explanatory value for survival outcomes.

### 4.4.3. Outcome 3: Length of ICU Stay by Diagnoses

```{r Length of ICU Stay by Diagnoses Exploratory Analysis}
# Extract top diagnoses based on frequency
top_diagnoses_los <- diagnoses %>%
  filter(SEQ_NUM == 1) %>%
  count(LONG_TITLE, sort = TRUE) %>%
  mutate(Percentage = n / sum(n) * 100,
         Cumulative_Percentage = cumsum(Percentage)) %>%
  filter(Cumulative_Percentage <= 35) %>%  # Adjust the threshold if necessary
  select(LONG_TITLE)

# Merge with LOS outcome data
diagnoses_los_outcome <- LOS_outcome %>%
  left_join(diagnoses, by = "SUBJECT_ID_COMPOSE") %>% 
  filter(SEQ_NUM == 1, LONG_TITLE %in% top_diagnoses_los$LONG_TITLE)

ggplot(diagnoses_los_outcome, aes(x = LONG_TITLE, y = LOS, fill = LONG_TITLE, color = LONG_TITLE)) +
  geom_boxplot(outlier.shape = NA, alpha = 0.7) +
  geom_jitter(width = 0.2, alpha = 0.5, fill = "white", shape = 21, size = 2, stroke = 0.5) +
  labs(title = "High-Priority Diagnoses by Length of ICU Stay",
       x = "High-Priority Diagnosis",
       y = "Length of ICU Stay (Days)") +
  scale_fill_manual(values = color_palette) +
  scale_color_manual(values = color_palette) +
  theme_custom +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

diagnoses_los_outcome <- LOS_outcome %>%
  left_join(diagnoses, by = "SUBJECT_ID_COMPOSE") %>%
  select(SUBJECT_ID_COMPOSE, LOS, LONG_TITLE, SEQ_NUM, DIAGNOSES_NUM)

# Plot: Average number of diagnoses per patient by LOS
diagnoses_los_outcome %>%
  group_by(LOS) %>%
  summarise(Average_Diagnoses = mean(DIAGNOSES_NUM, na.rm = TRUE), .groups = "drop") %>%
  ggplot(aes(x = LOS, y = Average_Diagnoses)) +
  geom_line(color = color_palette[10], size = 1.2) +  # Line for trend
  geom_point(color = color_palette[22], fill = "white", shape = 21, size = 2, stroke = 0.5) +  # Dots with outline
  geom_smooth(method = "loess", color = "darkblue", fill = "blue", alpha = 0.2, size = 1, se = TRUE) +  # LOESS smooth trend
  labs(
    title = "Average Number of Diagnoses by Length of ICU Stay",
    x = "Length of ICU Stay (Days)",
    y = "Average Number of Diagnoses"
  ) +
  scale_x_continuous(limits = c(0, max(diagnoses_los_outcome$LOS, na.rm = TRUE)), expand = c(0, 0)) + 
  scale_y_continuous(expand = c(0, 0)) + 
  theme_custom +
  theme(
    panel.grid.major = element_line(color = "grey40", size = 0.5),  # Add gridlines
    panel.grid.minor = element_line(color = "grey95", size = 0.25)
  )

```

This visualization indicates the relationship between specific diagnoses and the corresponding length of ICU stay. Diagnoses such as coronary artery diseases and septicemia are associated with longer stays in the ICU. This suggests that patients with these conditions require more intensive care, aligning with their critical nature.

Conclusion: High-priority diagnoses should be considered in ICU resource planning and can be used as predictors in modeling ICU length of stay.

Trend Observation: There is an increasing trend in the average number of diagnoses as the length of ICU stay increases. This suggests that patients who remain in the ICU longer often present with multiple comorbidities or complications requiring further diagnoses.

Conclusion: The average number of diagnoses can be a key factor when modeling ICU stays, as it reflects the complexity of the patient’s medical condition.

## 4.4. Exploratory analysis
### 4.4.1. Outcome 1: Death Status by Diagnoses

``` {r Death Status by Diagnoses exploratory analysis}
diagnoses_death_outcome$LONG_TITLE <- droplevels(diagnoses_death_outcome$LONG_TITLE)

result_diagnoses_num <- perform_statistical_tests(diagnoses_death_outcome, "SURVIVAL_FLAG", "DIAGNOSES_NUM", "Diagnoses number")

result_all_diagnosis <- perform_statistical_tests(diagnoses_death_outcome, "SURVIVAL_FLAG", "LONG_TITLE", "Diagnosis")

high_priority <- diagnoses_death_outcome %>%
  filter(SEQ_NUM == 1)

result_high_priority <- perform_statistical_tests(high_priority, "SURVIVAL_FLAG", "LONG_TITLE", "Key Diagnosis")

merged_results <- bind_rows(result_diagnoses_num, result_all_diagnosis, result_high_priority)

print(merged_results)

rm(result_diagnoses_num, result_all_diagnosis, high_priority, result_high_priority)
```

All three factors are significant predictors and should be integrated into the modeling framework. Their inclusion will enhance the accuracy and reliability of predictions related to death outcome.

### 4.4.2. Outcome 2: Length of Survival by Diagnoses

```{r Length of Survival by Diagnoses Exploratory analysis}
diagnoses_survival_outcome <- Survival_outcome %>%
  left_join(diagnoses, by = "SUBJECT_ID_COMPOSE") %>%
  select(SUBJECT_ID_COMPOSE, SURVIVAL, SURVIVAL_FLAG, DIAGNOSES_NUM, LONG_TITLE, SEQ_NUM) %>%
  mutate(
    SURVIVAL_FLAG = as.numeric(as.character(SURVIVAL_FLAG)) 
  )

# Create number of diagnoses ranges based on AGE_AT_ADMISSION
diagnoses_survival_numbers <- diagnoses_survival_outcome %>%
  select(SUBJECT_ID_COMPOSE, SURVIVAL, SURVIVAL_FLAG, DIAGNOSES_NUM) %>%
  distinct() %>%
  mutate(
    DIAGNOSES_NUM = cut(DIAGNOSES_NUM,
                    breaks = c(0, 1, 3, 5, 10, 40),  # Include 0-1 as the first interval
                    labels = c("1", "1-3", "3-5", "6-10", ">10"),  # Five intervals
                    right = FALSE)  # Include the left boundary in each group
  )

# Generate Kaplan-Meier survival curve by GENDER
fit_diagnoses_num <- survfit(Surv(SURVIVAL, SURVIVAL_FLAG) ~ DIAGNOSES_NUM, data = diagnoses_survival_numbers)

# Plot the Kaplan-Meier curve
ggsurvplot(
  fit_diagnoses_num,
  data = diagnoses_survival_outcome,
  pval = TRUE,  # Display p-value for gender
  conf.int = TRUE,  # Add confidence intervals
  ggtheme = theme_custom,
  surv.median.line = "hv",
  legend.title = "Number of Diagnoses",
  title = "Survival Curve by Y",
  palette =  color_palette
)

hr_table_number_diagnoses <- HR_assessment("SURVIVAL", "SURVIVAL_FLAG", "DIAGNOSES_NUM", diagnoses_survival_numbers)

print(hr_table_number_diagnoses)

rm(diagnoses_survival_outcome, diagnoses_survival_numbers, fit_diagnoses_num, hr_table_number_diagnoses)

```

The number of diagnoses (grouped as above) may not be a reliable predictor for survival outcomes in this dataset.


### 4.4.3. Outcome 3: Length of ICU Stay by Diagnoses

``` {r Length of ICU Stay by Diagnoses Data Exploratory Analysis}
diagnoses_LOS_numbers <- diagnoses_los_outcome %>%
  select(SUBJECT_ID_COMPOSE, LOS, DIAGNOSES_NUM) %>%
  distinct() %>%
  mutate(
    DIAGNOSES_NUM = cut(DIAGNOSES_NUM,
                    breaks = c(0, 1, 3, 5, 10, 40),  # Include 0-1 as the first interval
                    labels = c("1", "1-3", "3-5", "6-10", ">10"),  # Five intervals
                    right = FALSE)  # Include the left boundary in each group
  )

result_diagnoses_num <- analyze_predictor_LOS(diagnoses_LOS_numbers, predictor = "DIAGNOSES_NUM", LOS = "LOS", patient_id = "SUBJECT_ID_COMPOSE")

print(result_diagnoses_num)

rm(result_diagnoses_num, diagnosis_LOS_numbers, diagnoses_los_outcome)
```

Higher numbers of diagnoses (6-10 and >10) are predictive of longer ICU stays, as indicated by statistically significant results.

# 5. Isolations Data
## 5.1. Read data

``` {r read data isolations}
isolations <- read.csv("../data/raw/cleaned/CALLOUT_clean.csv", stringsAsFactors = TRUE) %>%
  mutate(across(where(is.character), as.factor))  %>%
  filter(SUBJECT_ID %in% subject_ids_adults) %>%
  mutate(SUBJECT_ID = as.factor(SUBJECT_ID),
         REQUEST_TELE = as.factor(REQUEST_TELE),
         REQUEST_RESP = as.factor(REQUEST_RESP),
         REQUEST_CDIFF = as.factor(REQUEST_CDIFF),
         REQUEST_MRSA = as.factor(REQUEST_MRSA),
         REQUEST_VRE = as.factor(REQUEST_VRE))

skimr::skim(isolations %>%
              select(-SUBJECT_ID, -HADM_ID, -ROW_ID))
```

## 5.2.   Descriptive Statistics
### 5.2.1. Descriptive statistics for categorical variables (Isolations Data)

```{r descriptive statistics for categorical vars (Isolations Data)}
# Clean and summarize the categorical data for all factor variables
isolations %>%
  select(-SUBJECT_ID, -SUBJECT_ID_COMPOSE, -OUTCOMETIME) %>%
  select(where(is.factor)) %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "Value") %>%
  group_by(Variable, Value) %>%
  summarise(n = n(), .groups = 'drop') %>%
  group_by(Variable) %>%
  mutate(`No data` = sum(is.na(Value)),
         `% by group` = (n / sum(n)) * 100) %>%
  ungroup() %>%
  select(Variable, Value, n, `% by group`, `No data`) %>%
  arrange(Variable, Value) %>%
  flextable() %>%
  merge_v("Variable") %>%
  autofit() %>%
  border_inner(border = fp_border(color = "black", width = 1)) %>%
  border_outer(border = fp_border(color = "black", width = 1))
```

## 5.3. Visualisation Analysis by Outcome
### 5.3.1. Outcome 1: Death Status by Isolations Data

```{r Death Status by Isolations Data}
isolations_death_outcome <- Death_status_outcome %>%
  left_join(isolations, by = "SUBJECT_ID_COMPOSE") %>%
  select(SUBJECT_ID_COMPOSE, SURVIVAL_FLAG, REQUEST_VRE, REQUEST_TELE, REQUEST_RESP, REQUEST_MRSA, REQUEST_CDIFF) %>%
  filter(!is.na(REQUEST_VRE) & !is.na(REQUEST_TELE) & !is.na(REQUEST_RESP) & !is.na(REQUEST_MRSA) & !is.na(REQUEST_CDIFF))

# Reshape the data to long format
data_long <- isolations_death_outcome %>%
  pivot_longer(cols = c(REQUEST_VRE, REQUEST_TELE, REQUEST_RESP, REQUEST_MRSA, REQUEST_CDIFF), 
               names_to = "Request_Type", 
               values_to = "Flag") %>%
  filter(!is.na(Flag))  # Remove rows where Flag is NA


# Ensure Flag is a binary column (0 or 1)
data_long$Flag <- as.integer(data_long$Flag)

# Group by SURVIVAL_FLAG and Request_Type, then calculate counts
count_data <- data_long %>%
  group_by(SURVIVAL_FLAG, Request_Type) %>%
  summarise(Count = sum(Flag == 1), .groups = "drop")  # Count where Flag == 1 (bacteria found)

# Plot the data
ggplot(count_data, aes(x = Request_Type, y = Count, fill = factor(SURVIVAL_FLAG))) +
  geom_bar(stat = "identity", position = "dodge2") +
  labs(title = "Count of Bacteria Requests by Death Status",
       x = "Request Type",
       y = "Count",
       fill = "Survival Status") +
  scale_fill_manual(values = c(color_palette[7], color_palette[12]), labels = c("Survived", "Died")) +
  geom_text(aes(label = Count), vjust = -0.5, position = position_dodge(0.9), size = 3.5) +  # Add text labels
  theme_custom +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate the x-axis labels for better readability

rm(count_data, data_long)
```

### 5.3.2. Outcome 2: Length of Survival by Isolations Data

```{r Length of Survival by Isolations Data}

isolations_survival_outcome <- Survival_outcome %>%
  left_join(isolations, by = "SUBJECT_ID_COMPOSE") %>%
  select(SUBJECT_ID_COMPOSE, SURVIVAL_FLAG, SURVIVAL, REQUEST_VRE, REQUEST_TELE, REQUEST_RESP, REQUEST_MRSA, REQUEST_CDIFF) %>%
  filter(!is.na(REQUEST_VRE) & !is.na(REQUEST_TELE) & !is.na(REQUEST_RESP) & !is.na(REQUEST_MRSA) & !is.na(REQUEST_CDIFF))

# Reshape the data to long format for better visualization
isolations_long <- isolations_survival_outcome %>%
  pivot_longer(cols = c(REQUEST_VRE, REQUEST_TELE, REQUEST_RESP, REQUEST_MRSA, REQUEST_CDIFF), 
               names_to = "Isolation_Type", 
               values_to = "Isolation_Flag") %>%
  filter(!is.na(Isolation_Flag))  # Remove rows with missing values for Isolation_Flag

# Plot: Boxplot of Survival Time by Isolation Flag
ggplot(isolations_long, aes(x = factor(Isolation_Flag), y = SURVIVAL, fill = factor(Isolation_Flag))) +
  geom_boxplot(outlier.shape = NA) +
  facet_wrap(~Isolation_Type) + 
  labs(title = "Survival Time by Bacterial Infection Requests (Isolation Flags)",
       x = "Isolation Flag (0 = No, 1 = Yes)", y = "Survival Time (Days)") +
  scale_fill_manual(values = c(color_palette[6], color_palette[10]), labels = c("No Infection", "Infection Detected")) +
  theme_custom +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

rm(isolations_long)

```

### 5.3.3. Outcome 3: Length of ICU Stay by Isolations Data

``` {r Length of ICU Stay by Isolations Data}
isolations_los_outcome <- LOS_outcome %>%
  left_join(isolations, by = "SUBJECT_ID_COMPOSE") %>%
  select(SUBJECT_ID_COMPOSE, LOS, REQUEST_VRE, REQUEST_TELE, REQUEST_RESP, REQUEST_MRSA, REQUEST_CDIFF) %>%
  filter(!is.na(REQUEST_VRE) & !is.na(REQUEST_TELE) & !is.na(REQUEST_RESP) & !is.na(REQUEST_MRSA) & !is.na(REQUEST_CDIFF))


# Reshape the data to long format for better visualization
isolations_long <- isolations_los_outcome %>%
  pivot_longer(cols = c(REQUEST_VRE, REQUEST_TELE, REQUEST_RESP, REQUEST_MRSA, REQUEST_CDIFF), 
               names_to = "Isolation_Type", 
               values_to = "Isolation_Flag") %>%
  filter(!is.na(Isolation_Flag))  # Remove rows with missing values for Isolation_Flag

# Plot: Boxplot of Survival Time by Isolation Flag
ggplot(isolations_long, aes(x = factor(Isolation_Flag), y = LOS, fill = factor(Isolation_Flag))) +
  geom_boxplot(outlier.shape = NA) +
  facet_wrap(~Isolation_Type) + 
  labs(title = "Survival Time by Bacterial Infection Requests (Isolation Flags)",
       x = "Isolation Flag (0 = No, 1 = Yes)", y = "Survival Time (Days)") +
  scale_fill_manual(values = c(color_palette[9], color_palette[15]), labels = c("No Infection", "Infection Detected")) +
  theme_custom +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

rm(isolations_long)
```

## 5.4. Exploratory analysis
### 5.4.1. Outcome 1: Death Status by Isolations Data

```{r Death Status by Isolations Data Exploratory Analysis}

result_TELE <- perform_statistical_tests(isolations_death_outcome, "SURVIVAL_FLAG", "REQUEST_TELE", "TELE")
result_RESP <- perform_statistical_tests(isolations_death_outcome, "SURVIVAL_FLAG", "REQUEST_RESP", "RESP")
result_CDIFF <- perform_statistical_tests(isolations_death_outcome, "SURVIVAL_FLAG", "REQUEST_CDIFF", "CDIFF")
result_MRSA <- perform_statistical_tests(isolations_death_outcome, "SURVIVAL_FLAG", "REQUEST_MRSA", "MRSA")
result_VRE <- perform_statistical_tests(isolations_death_outcome, "SURVIVAL_FLAG", "REQUEST_VRE", "VRE")

# Merge the results
merged_results <- bind_rows(result_TELE, result_RESP, result_CDIFF, result_MRSA, result_VRE)

print(merged_results)

rm(result_TELE, result_RESP, result_CDIFF, result_MRSA, result_VRE, merged_results, isolations_death_outcome)

```

TELE, CDIFF, MRSA, and VRE will be considered as key predictors in death outcome models.

### 5.4.2. Outcome 2: Length of Survival by Admissions Data

```{r Length of Survival by Isolations Data exploratory analysis}

# Generate Kaplan-Meier survival curve by GENDER
fit_TELE <- survfit(Surv(SURVIVAL, SURVIVAL_FLAG) ~ REQUEST_TELE, data = isolations_survival_outcome)

# Plot the Kaplan-Meier curve
ggsurvplot(
  fit_TELE,
  data = isolations_survival_outcome,
  pval = TRUE,  # Display p-value for gender
  conf.int = TRUE,  # Add confidence intervals
  ggtheme = theme_custom,
  surv.median.line = "hv",
  legend.title = "Admission type",
  title = "Survival Curve by Admission Type",
  palette =  color_palette
)

# Generate Kaplan-Meier survival curve by GENDER
fit_RESP <- survfit(Surv(SURVIVAL, SURVIVAL_FLAG) ~ REQUEST_RESP, data = isolations_survival_outcome)

# Plot the Kaplan-Meier curve 
ggsurvplot(
  fit_RESP,
  data = isolations_survival_outcome,
  pval = TRUE,  # Display p-value for age groups
  conf.int = TRUE,  # Add confidence intervals
  ggtheme = theme_custom,
  surv.median.line = "hv",
  legend.title = "Insurance",
  title = "Survival Curve by Insurance",
  palette = color_palette
)

# Fit Kaplan-Meier model
fit_CDIFF <- survfit(Surv(SURVIVAL, SURVIVAL_FLAG) ~ REQUEST_CDIFF, data = isolations_survival_outcome)

# Plot the Kaplan-Meier curve
ggsurvplot(
  fit_CDIFF,
  data = isolations_survival_outcome,
  pval = TRUE,  # Display p-value
  conf.int = TRUE,  # Add confidence intervals
  ggtheme = theme_custom,
  surv.median.line = "hv",
  legend.title = "Religion",
  title = "Survival Curve by Religion",
  palette = color_palette
)

# Fit Kaplan-Meier model
fit_MRSA <- survfit(Surv(SURVIVAL, SURVIVAL_FLAG) ~ REQUEST_MRSA, data = isolations_survival_outcome)

# Plot the Kaplan-Meier curve
ggsurvplot(
  fit_MRSA,
  data = isolations_survival_outcome,
  pval = TRUE,  # Display p-value
  conf.int = TRUE,  # Add confidence intervals
  ggtheme = theme_custom,
  surv.median.line = "hv",
  legend.title = "Marital Status",
  title = "Survival Curve by Marital Status",
  palette = color_palette
)

# Fit Kaplan-Meier model
fit_VRE <- survfit(Surv(SURVIVAL, SURVIVAL_FLAG) ~ REQUEST_VRE, data = isolations_survival_outcome)

# Plot the Kaplan-Meier curve
ggsurvplot(
  fit_VRE,
  data = isolations_survival_outcome,
  pval = TRUE,  # Display p-value
  conf.int = TRUE,  # Add confidence intervals
  ggtheme = theme_custom,
  surv.median.line = "hv",
  legend.title = "Ethnicity",
  title = "Survival Curve by Ethnicity",
  palette = color_palette
)

hr_table <- HR_assessment("SURVIVAL", "SURVIVAL_FLAG", c("REQUEST_TELE", "REQUEST_RESP", "REQUEST_CDIFF", "REQUEST_MRSA", "REQUEST_VRE"), isolations_survival_outcome)

print(hr_table)

rm(isolations_survival_outcome, hr_table, fit_TELE, fit_CDIFF, fit_RESP, fit_MRSA, fit_VRE)

```

Increased Risk: Significant risks are observed for Clostridium Difficile (CDIFF) and Vancomycin-Resistant Enterococci (VRE), which both increase the risk of death.

Decreased Risk: Telemedicine (TELE) is associated with a significant reduction in the risk of death.

No Significant Effect: Respiratory infections (RESP) and MRSA do not show statistically significant effects on survival.

In summary, REQUEST_TELE, REQUEST_CDIFF, and REQUEST_VRE are strong candidates for inclusion in future models, while REQUEST_RESP and REQUEST_MRSA can be excluded or investigated further for possible significance with a larger dataset.

### 5.4.3. Outcome 3: Length of ICU Stay by Isolations Data

``` {r Length of ICU Stay by isolations Data exploratary analysis}
  
result_TELE <- analyze_predictor_LOS(isolations_los_outcome, predictor = "REQUEST_TELE", LOS = "LOS", patient_id = "SUBJECT_ID_COMPOSE")
result_RESP <- analyze_predictor_LOS(isolations_los_outcome, predictor = "REQUEST_RESP", LOS = "LOS", patient_id = "SUBJECT_ID_COMPOSE")
result_CDIFF <- analyze_predictor_LOS(isolations_los_outcome, predictor = "REQUEST_CDIFF", LOS = "LOS", patient_id = "SUBJECT_ID_COMPOSE")
result_MRSA <- analyze_predictor_LOS(isolations_los_outcome, predictor = "REQUEST_MRSA", LOS = "LOS", patient_id = "SUBJECT_ID_COMPOSE")
result_VRE <- analyze_predictor_LOS(isolations_los_outcome, predictor = "REQUEST_VRE", LOS = "LOS", patient_id = "SUBJECT_ID_COMPOSE")

# Merge the results
merged_results <- bind_rows(result_TELE, result_RESP, result_CDIFF, result_MRSA, result_VRE)

print(merged_results)

rm(isolations, isolations_los_outcome, merged_results, result_TELE, result_RESP, result_CDIFF, result_MRSA, result_VRE)
```

REQUEST_CDIFF, REQUEST_MRSA, and REQUEST_VRE as strong predictors of LOS.

# 6. Prescriptions Data
# 6.1. Read data

``` {r read data prescriptions}
prescriptions <- read.csv("../data/raw/cleaned/PRESCRIPTIONS_clean.csv", stringsAsFactors = TRUE) %>%
  mutate(across(where(is.character), as.factor))  %>%
  filter(SUBJECT_ID %in% subject_ids_adults) %>%
  mutate(SUBJECT_ID = as.factor(SUBJECT_ID),
         ICUSTAY_ID = as.factor(ICUSTAY_ID),
         ATC_ID = as.factor(ATC_ID),
         STARTDATE = as.Date(STARTDATE),
         ENDDATE = as.Date(ENDDATE)) %>%
  select(-DRUG, -NDC, -DOSE_VAL_RX, -DOSE_UNIT_RX, -RXCUI, -COMBINED_INFO, -ATC_TYPE) 

skimr::skim(prescriptions %>%
              select(-SUBJECT_ID, -HADM_ID, -SUBJECT_ID_COMPOSE, -ICUSTAY_ID))
```
## 6.2. Desriptive statistics

### 6.2.1. Descriptive statistics for categorical variables Prescriptions data)

```{r descriptive statistica prescriptions}
# Clean and summarize the categorical data for all factor variables
prescriptions %>%
  select(-SUBJECT_ID, -HADM_ID, -SUBJECT_ID_COMPOSE, -ICUSTAY_ID, -ATC_ID) %>%
  select(where(is.factor)) %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "Value") %>%
  filter(!is.na(Value)) %>%
  group_by(Variable, Value) %>%
  summarise(n = n(), .groups = 'drop') %>%
  group_by(Variable) %>%
  mutate(`No data` = sum(is.na(Value)),
         `% by group` = (n / sum(n)) * 100) %>%
  ungroup() %>%
  filter(`% by group` > 0.5) %>%
  select(Variable, Value, n, `% by group`, `No data`) %>%
  arrange(Variable, Value) %>%
  flextable() %>%
  merge_v("Variable") %>%
  autofit() %>%
  border_inner(border = fp_border(color = "black", width = 1)) %>%
  border_outer(border = fp_border(color = "black", width = 1))
```

## 6.3. Visualisation Analysis by Outcome
### 6.3.1. Outcome 1: Death Status by Prescripions Data

```{r Death Status by Prescripions Data}

# Assuming Death_status_outcome contains death information and prescriptions has drug data
prescriptions_death_outcome <- Death_status_outcome %>%
  left_join(prescriptions, by = c("SUBJECT_ID_COMPOSE", "SUBJECT_ID")) %>% 
  distinct() %>%
  select("SUBJECT_ID_COMPOSE", ATC_NAME, DRUG_TYPE, DRUG_NAME_GENERIC, SURVIVAL_FLAG)

prescriptions_death_outcome %>%
  group_by(SUBJECT_ID_COMPOSE, SURVIVAL_FLAG) %>%  
  summarise(
    num_drugs = n_distinct(DRUG_NAME_GENERIC), 
    .groups = "drop"
  ) %>%
  group_by(SURVIVAL_FLAG) %>%                     
  summarise(
    avg_prescriptions_per_patient = mean(num_drugs, na.rm = TRUE), 
    total_patients = n(),                                
    .groups = "drop"
  ) %>%
ggplot(aes(x = factor(SURVIVAL_FLAG), y = avg_prescriptions_per_patient, fill = factor(SURVIVAL_FLAG))) +
  geom_bar(stat = "identity", width = 0.6) +
  geom_text(
    aes(label = sprintf("%.2f", avg_prescriptions_per_patient)),
    position = position_stack(vjust = 0.5),
    size = 5                                
  ) +
  labs(
    title = "Average Number of Drugs per Patient by Survival Status",
    x = "Survival Status",
    y = "Average Number of Drugs",
    fill = "Survival Status"
  ) +
 scale_fill_manual(
    values = sample(color_palette, size = length(unique(prescriptions_death_outcome$SURVIVAL_FLAG)), replace = FALSE),
    labels = c("0" = "Not Dead", "1" = "Dead")
    ) +
  theme_custom +                                                  # Apply custom theme
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold")
  )

# Calculate mean number of drugs by DRUG_TYPE and Survival Status
prescriptions_death_outcome %>%
  group_by(SUBJECT_ID_COMPOSE, SURVIVAL_FLAG, DRUG_TYPE) %>%
  summarise(
    num_drugs = n_distinct(DRUG_NAME_GENERIC),  # Count distinct drugs per patient by drug type
    .groups = "drop"
  ) %>%
  group_by(DRUG_TYPE, SURVIVAL_FLAG) %>%
  summarise(
    avg_prescriptions_per_patient = mean(num_drugs, na.rm = TRUE),  # Average drugs per drug type
    total_patients = n(),                                  # Count total patients
    .groups = "drop"
  ) %>%
ggplot(aes(x = DRUG_TYPE, y = avg_prescriptions_per_patient, fill = factor(SURVIVAL_FLAG))) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8), width = 0.6) +
  geom_text(
    aes(label = sprintf("%.2f", avg_prescriptions_per_patient)),  # Add average drugs labels
    position = position_dodge(width = 0.8),               # Place text above bars
    vjust = -0.5,                                         # Adjust vertical position
    size = 4                                              # Adjust text size
  ) +
  labs(
    title = "Average Number of Drugs by Drug Type and Survival Status",
    x = "Drug Type",
    y = "Average Number of Drugs",
    fill = "Survival Status"
  ) +
   scale_fill_manual(
    values = sample(color_palette, size = length(unique(prescriptions_death_outcome$SURVIVAL_FLAG)), replace = FALSE),
    labels = c("0" = "Not Dead", "1" = "Dead")
    ) +
  theme_custom +                                          # Apply custom theme
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1)     # Rotate x-axis labels for better readability
  )

# Filter for DRUG_TYPE == "MAIN" and find the most common drugs by survival flag
top_common_drugs <- prescriptions_death_outcome %>%
  filter(DRUG_TYPE == "MAIN") %>%                # Filter rows where DRUG_TYPE is "MAIN"
  group_by(SURVIVAL_FLAG, DRUG_NAME_GENERIC) %>%
  summarise(count = n(), .groups = "drop") %>%   # Count occurrences of each drug
  arrange(SURVIVAL_FLAG, desc(count)) %>%        # Sort by survival flag and count (descending)
  group_by(SURVIVAL_FLAG) %>%
  slice_head(n = 20) %>%                          # Select the top 5 most common drugs for each survival flag
  ungroup()

# Visualize the top common drugs as a grouped bar plot
ggplot(top_common_drugs, aes(x = reorder(DRUG_NAME_GENERIC, -count), y = count, fill = factor(SURVIVAL_FLAG))) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8), width = 0.6) +
  labs(
    title = "Top 5 Most Common Main Drugs by Survival Flag",
    x = "Drug Name (Generic)",
    y = "Count",
    fill = "Survival Status"
  ) +
   scale_fill_manual(
    values = sample(color_palette, size = length(unique(prescriptions_death_outcome$SURVIVAL_FLAG)), replace = FALSE),
    labels = c("0" = "Not Dead", "1" = "Dead")
    ) +
  coord_flip() +
  theme_custom +
  theme(
    legend.position = "top",
    axis.text.x = element_text(angle = 45, hjust = 1)     # Rotate x-axis labels for better readability
  )

# Identify top ATC names by frequency
top_atc_names <- prescriptions_death_outcome %>%
  group_by(ATC_NAME) %>%
  summarise(count = n(), .groups = "drop") %>%         # Count occurrences of each ATC name
  arrange(desc(count)) %>%                            # Sort by descending frequency
  slice_head(n = 10)                                  # Select top 10 ATC names

# Visualize top ATC names
ggplot(top_atc_names, aes(x = reorder(ATC_NAME, -count), y = count)) +
  geom_bar(stat = "identity", fill = "pink", width = 0.7) +
  geom_text(aes(label = count), hjust = -0.5, size = 4) +
  labs(
    title = "Top 10 ATC Names",
    x = "ATC Name",
    y = "Frequency"
  ) +
  coord_flip() +
  theme_custom +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),  # Rotate x-axis labels for readability
  )

rm(top_common_drugs, top_atc_names)

```

### 6.3.2. Outcome 2: Length of Survival by Prescriptions Data

```{r Length of Survival by Prescriptions Data}
prescriptions_survival_outcome <- Survival_outcome %>%
  left_join(prescriptions, by = c("SUBJECT_ID", "SUBJECT_ID_COMPOSE")) %>%
  distinct()

prescriptions_survival_outcome %>%
  group_by(SUBJECT_ID_COMPOSE, SURVIVAL) %>%
  summarise(
    num_drugs = n_distinct(DRUG_NAME_GENERIC),  # Count distinct drugs per patient
    .groups = "drop"
  ) %>%
  ggplot(aes(x = num_drugs)) +
  geom_density(fill = color_palette[8], alpha = 0.6) +
  labs(
    title = "Density of Number of Drugs by Survival (Days)",
    x = "Number of Drugs",
    y = "Density"
  ) +
  theme_custom +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

# Boxplot: Survival distribution by drug type
prescriptions_survival_outcome %>%
  ggplot(aes(x = DRUG_TYPE, y = SURVIVAL, fill = DRUG_TYPE)) +
  geom_boxplot(outlier.color = "black") +
  labs(
    title = "Survival Distribution by Drug Type",
    x = "Drug Type",
    y = "Survival (Days)"
  ) +
  scale_fill_manual(
    values = sample(color_palette, size = length(unique(prescriptions_survival_outcome$DRUG_TYPE)), replace = FALSE)
    ) +
  theme_custom +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(hjust = 0.5, face = "bold")
  )

# Filter for DRUG_TYPE == "MAIN" and find the most common drugs
top_common_drugs <- prescriptions_survival_outcome %>%
  filter(DRUG_TYPE == "MAIN") %>%               
  group_by(DRUG_NAME_GENERIC) %>%
  summarise(count = n(), .groups = "drop") %>%    # Count occurrences of each drug
  arrange(desc(count)) %>%                       # Sort by descending frequency
  slice_head(n = 20)                             # Select the top 20 most common drugs

# Boxplot: Survival distribution by top generic names
prescriptions_survival_outcome %>%
  filter(DRUG_NAME_GENERIC %in% unique(top_common_drugs$DRUG_NAME_GENERIC)) %>%
  ggplot(aes(x = reorder(DRUG_NAME_GENERIC, SURVIVAL), y = SURVIVAL, fill = DRUG_NAME_GENERIC)) +
  geom_boxplot(outlier.color = "black") +
  coord_flip() +
  labs(
    title = "Survival Distribution by Top Generic Names",
    x = "Generic Name",
    y = "Survival (Days)"
  ) +
  scale_fill_manual(
    values = sample(color_palette, size = length(unique(top_common_drugs$DRUG_NAME_GENERIC)), replace = FALSE)
  ) +
  theme_custom +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1),  # Rotate x-axis labels
    plot.title = element_text(hjust = 0.5, face = "bold")
  )
```

### 6.3.3. Outcome 3: Length of ICU Stay by Prescriptions Data

```{r Length of ICU Stay by Prescriptions Data}
prescriptions_los_outcome <- LOS_outcome %>%
  left_join(prescriptions, by = c("SUBJECT_ID_COMPOSE", "ICUSTAY_ID", "SUBJECT_ID")) %>%
  distinct()

# Density plot: Number of drugs vs. LOS
prescriptions_los_outcome %>%
  group_by(SUBJECT_ID_COMPOSE, LOS) %>%
  summarise(
    num_drugs = n_distinct(DRUG_NAME_GENERIC),  # Count distinct drugs per patient
    .groups = "drop"
  ) %>%
  ggplot(aes(x = num_drugs)) +
  geom_density(fill = color_palette[8], alpha = 0.6) +
  labs(
    title = "Density of Number of Drugs by LOS (Days)",
    x = "Number of Drugs",
    y = "Density"
  ) +
  theme_custom +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

# Boxplot: LOS distribution by drug type
prescriptions_los_outcome %>%
  ggplot(aes(x = DRUG_TYPE, y = LOS, fill = DRUG_TYPE)) +
  geom_boxplot(outlier.color = "black") +
  labs(
    title = "LOS Distribution by Drug Type",
    x = "Drug Type",
    y = "LOS (Days)"
  ) +
  scale_fill_manual(
    values = sample(color_palette, size = length(unique(prescriptions_los_outcome$DRUG_TYPE)), replace = FALSE)
  ) +
  theme_custom +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(hjust = 0.5, face = "bold")
  )

# Filter for DRUG_TYPE == "MAIN" and find the most common drugs
top_common_drugs <- prescriptions_los_outcome %>%
  filter(DRUG_TYPE == "MAIN") %>%               
  group_by(DRUG_NAME_GENERIC) %>%
  summarise(count = n(), .groups = "drop") %>%    # Count occurrences of each drug
  arrange(desc(count)) %>%                       # Sort by descending frequency
  slice_head(n = 20)                             # Select the top 20 most common drugs

# Boxplot: LOS distribution by top generic names
prescriptions_los_outcome %>%
  filter(DRUG_NAME_GENERIC %in% unique(top_common_drugs$DRUG_NAME_GENERIC)) %>%
  ggplot(aes(x = reorder(DRUG_NAME_GENERIC, LOS), y = LOS, fill = DRUG_NAME_GENERIC)) +
  geom_boxplot(outlier.color = "black") +
  coord_flip() +
  labs(
    title = "LOS Distribution by Top Generic Names",
    x = "Generic Name",
    y = "LOS (Days)"
  ) +
  scale_fill_manual(
    values = sample(color_palette, size = length(unique(top_common_drugs$DRUG_NAME_GENERIC)), replace = FALSE)
  ) +
  theme_custom +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1),  # Rotate x-axis labels
    plot.title = element_text(hjust = 0.5, face = "bold")
  )

# Identify top ATC names by frequency
top_atc_names <- prescriptions_los_outcome %>%
  group_by(ATC_NAME) %>%
  summarise(count = n(), .groups = "drop") %>%
  arrange(desc(count)) %>%
  slice_head(n = 10)  # Select the top 10 ATC names

# Boxplot: LOS distribution by top ATC names
prescriptions_los_outcome %>%
  filter(ATC_NAME %in% unique(top_atc_names$ATC_NAME)) %>%
  ggplot(aes(x = reorder(ATC_NAME, LOS), y = LOS, fill = ATC_NAME)) +
  geom_boxplot(outlier.color = "black") +
  coord_flip() +
  labs(
    title = "LOS Distribution by Top ATC Names",
    x = "ATC Name",
    y = "LOS (Days)"
  ) +
  scale_fill_manual(
    values = sample(color_palette, size = length(unique(top_atc_names$ATC_NAME)), replace = FALSE)
  ) +
  theme_custom +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1)  # Rotate x-axis labels for readability
  )
```

## 6.4. Exploratory analysis
### 6.4.1. Outcome 1: Death Status by Prescriptions Data

```{r Death Status by Prescriptions Data Exploratory Analysis}
prescriptions_number <- prescriptions_death_outcome %>%
  group_by(SUBJECT_ID_COMPOSE, SURVIVAL_FLAG) %>%
  summarise(
    PRESCRIPTIONS_NUM = n(),  # Count total prescriptions per patient
    .groups = "drop"
  )

result_prescriptions_number <- perform_statistical_tests(prescriptions_number, "SURVIVAL_FLAG", "PRESCRIPTIONS_NUM", "Prescription number")
result_drug_type <- perform_statistical_tests(prescriptions_death_outcome, "SURVIVAL_FLAG", "DRUG_TYPE", "Drug type")
result_ATC <- perform_statistical_tests(prescriptions_death_outcome, "SURVIVAL_FLAG", "ATC_NAME", "ATC name")
result_generic_name <- perform_statistical_tests(prescriptions_death_outcome, "SURVIVAL_FLAG", "DRUG_NAME_GENERIC", "Generic name")

# Merge the results
merged_results <- bind_rows(result_prescriptions_number, result_ATC, result_drug_type, result_generic_name)

print(merged_results)

rm(prescriptions_number, result_prescriptions_number, result_ATC, result_generic_name)
```

### 6.4.2. Outcome 2: Length of Survival by Prescriptions

```{r Length of Survival by Prescriptions Exploratory analysis}
# Merge survival outcome with prescriptions and create DRUGS_NUM
prescriptions_survival_outcome <- Survival_outcome %>%
  left_join(prescriptions, by = "SUBJECT_ID_COMPOSE") %>%
  group_by(SUBJECT_ID_COMPOSE, SURVIVAL, SURVIVAL_FLAG) %>%
  summarise(
    DRUGS_NUM = n_distinct(DRUG_NAME_GENERIC),  # Count distinct drugs prescribed for each patient
    .groups = "drop"
  ) %>%
  mutate(
    SURVIVAL_FLAG = as.numeric(as.character(SURVIVAL_FLAG))  # Ensure SURVIVAL_FLAG is numeric
  )

# Create number of drugs ranges
prescriptions_survival_numbers <- prescriptions_survival_outcome %>%
  distinct() %>%
  mutate(
    prescriptions_NUM = cut(DRUGS_NUM,
                    breaks = c(0, 1, 3, 10, 20, 30, Inf),  # Include 0-1 as the first interval
                    labels = c("1", "1-3", "3-10", "10-20", "20-30", ">30"),  # Five intervals
                    right = FALSE)  # Include the left boundary in each group
  )

# Generate Kaplan-Meier survival curve by number of drugs
fit_prescriptions_num <- survfit(Surv(SURVIVAL, SURVIVAL_FLAG) ~ prescriptions_NUM, data = prescriptions_survival_numbers)

# Plot the Kaplan-Meier curve
ggsurvplot(
  fit_prescriptions_num,
  data = prescriptions_survival_numbers,
  pval = TRUE,  # Display p-value for drug number
  conf.int = TRUE,  # Add confidence intervals
  ggtheme = theme_custom,
  surv.median.line = "hv",
  legend.title = "Number of Drugs",
  title = "Survival Curve by Number of Drugs",
  palette = color_palette
)

# Perform Hazard Ratio (HR) assessment
hr_table_number_drugs <- HR_assessment("SURVIVAL", "SURVIVAL_FLAG", "prescriptions_NUM", prescriptions_survival_numbers)

print(hr_table_number_drugs)

# Remove intermediate objects to clean up
rm(prescriptions_survival_outcome, prescriptions_survival_numbers, fit_prescriptions_num, hr_table_number_drugs)

```

PRESCRIPTIONS_NUM should be included as a predictor in future modeling.

Significant Risk: All intervals show highly significant hazard ratios (HR) with p < 0.0001, indicating it is strongly associated with survival outcomes.

### 6.4.3. Outcome 3: Length of ICU Stay by Prescriptions Data

```{r Length of ICU Stay by Prescriptions Data Exploratory analysis}
prescriptions_LOS_numbers <- prescriptions_los_outcome %>%
  group_by(SUBJECT_ID_COMPOSE, ICUSTAY_ID, LOS) %>%
  summarise(
    PRESCRIPTIONS_NUM = n_distinct(DRUG_NAME_GENERIC),  # Count unique prescriptions per patient
    .groups = "drop"
  ) %>%
  mutate(
    PRESCRIPTIONS_NUM = cut(PRESCRIPTIONS_NUM,
                            breaks = c(0, 1, 3, 10, 20, 30, Inf),  # Include 0-1 as the first interval
                            labels = c("1", "1-3", "3-10", "10-20", "20-30", ">30"),  # Five intervals
                            right = FALSE)  # Include the left boundary in each group
  )

# Analyze LOS by prescription intervals
result_prescriptions_num <- analyze_predictor_LOS(
  prescriptions_LOS_numbers,
  predictor = "PRESCRIPTIONS_NUM",
  LOS = "LOS",
  patient_id = "SUBJECT_ID_COMPOSE"
)

# Print the result
print(result_prescriptions_num)

# Remove intermediate objects
rm(result_prescriptions_num, prescriptions_LOS_numbers, prescriptions_los_outcome)

```

PRESCRIPTIONS_NUM is a significant predictor for the length of ICU stay based on mixed-effects model results. All groups demonstrate statistical significance (p < 0.001), indicating that the number of prescriptions is associated with variations in ICU stay duration.

PRESCRIPTIONS_NUM should be included in future models for ICU stay prediction.

# 7. Laborotory Analyses Data (Blood)
## 7.1. Read data

``` {r read data blood analyses}
labs_blood <- read.csv("../data/raw/cleaned/LABEVENTS_clean.csv", stringsAsFactors = TRUE) %>%
  group_by(SUBJECT_ID_COMPOSE, SUBJECT_ID, HADM_ID) %>%
  mutate(VISIT_NUM = cumsum(SEQ_NUM == 1),
         VISIT_NUM = if_else(VISIT_NUM == 0, cumsum(SEQ_NUM == 2), VISIT_NUM),
         VISIT_NUM = if_else(VISIT_NUM == 0, cumsum(SEQ_NUM == 3), VISIT_NUM)
         ) %>%
  # check if VISIT_NUM == 0 cumsum(SEQ_NUM == 2)
  ungroup() %>%
  filter(FLUID == "BLOOD") %>%
  mutate(across(where(is.character), as.factor))  %>%
  filter(SUBJECT_ID %in% subject_ids_adults) %>%
    filter(HADM_ID != 0 ) %>%
  select(-ITEMID)
  


skimr::skim(labs_blood %>%
  select(-SUBJECT_ID, -HADM_ID, -SUBJECT_ID_COMPOSE, -CHARTTIME))
```
## 7.2.   Descriptive Statistics
### 7.2.1. Descriptive statistics for categorical variables (Laboratory Data (Blood))

```{r Descriptive statistics for procedures for categorical vars (Laboratory Data (Blood)}
# Clean and summarize the categorical data for all factor variables
labs_blood %>%
  select(LABEL, CATEGORY) %>%
  select(where(is.factor)) %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "Value") %>%
  group_by(Variable, Value) %>%
  summarise(n = n(), .groups = 'drop') %>%
  group_by(Variable) %>%
  mutate(`No data` = sum(is.na(Value)),
         `% by group` = (n / sum(n)) * 100) %>%
  ungroup() %>%
  select(Variable, Value, n, `% by group`, `No data`) %>%
  arrange(Variable, desc(n)) %>%
  flextable() %>%
  merge_v("Variable") %>%
  autofit() %>%
  border_inner(border = fp_border(color = "black", width = 1)) %>%
  border_outer(border = fp_border(color = "black", width = 1))
```

## 7.3. Visualisation Analysis by Outcome
### 7.3.1. Outcome 1: Death Status by Laboratory Data (Blood)
#### 7.3.1.1. Blood Gas

``` {r (Blood Gas) Data transformation}
labs_blood_gas <- labs_blood %>%
  filter(CATEGORY == "BLOOD GAS") %>%
  select(SUBJECT_ID_COMPOSE, CHARTTIME, LABEL, SEQ_NUM, VISIT_NUM, VALUENUM) %>%
  distinct()

labs_blood_gas <- labs_blood_gas %>%
  pivot_wider(
    names_from = LABEL,
    values_from = VALUENUM,
    values_fill = list(VALUENUM = NA)
  ) %>%
  select(-CHARTTIME, -INTUBATED, -`SPECIMEN TYPE`) %>%
  distinct()

labs_blood_gas_combined <- labs_blood_gas %>%
  group_by(SUBJECT_ID_COMPOSE, VISIT_NUM) %>%
  summarise(across(
    everything(), 
    ~ if (all(is.na(.))) NA else na.omit(.)[1], # Keep the first non-NA value for each column
    .names = "{.col}"
  )) %>%
  select(-SEQ_NUM) %>%
  ungroup()

```

``` {r Death Status by Laboratory Data (Blood Gas)}
labs_blood_gas_death_outcome <- labs_blood_gas_combined %>%
  left_join(Death_status_outcome, by = "SUBJECT_ID_COMPOSE") %>%
  select(-SUBJECT_ID) %>%
  filter(!is.na(SURVIVAL_FLAG))

# Visualise how differ all numeric vars according to death status
# Filter numeric variables with sufficient variance
numeric_vars <- labs_blood_gas_death_outcome %>%
  select(-SUBJECT_ID_COMPOSE, -SURVIVAL_FLAG, -VISIT_NUM) %>%
  select(where(is.numeric)) %>%
  summarise(across(everything(), ~ var(., na.rm = TRUE))) %>%
  pivot_longer(everything(), names_to = "Variable", values_to = "Variance") %>%
  filter(Variance > 0) %>%
  pull(Variable)

# Filter data for plotting
filtered_data <- labs_blood_gas_death_outcome %>%
  select(SUBJECT_ID_COMPOSE, VISIT_NUM, SURVIVAL_FLAG, all_of(numeric_vars)) %>%
  group_by(SURVIVAL_FLAG, VISIT_NUM) %>%
  summarise(across(everything(), ~ mean(., na.rm = TRUE), .names = "Mean_{.col}"), .groups = "drop")

# Melt the data for easier plotting
melted_data <- filtered_data %>%
  pivot_longer(cols = -c(SURVIVAL_FLAG, VISIT_NUM), names_to = "Variable", values_to = "Value")

# Plot density plots for each variable
for (variable in unique(melted_data$Variable)) {
  plot <- ggplot(melted_data %>% filter(Variable == variable), aes(x = VISIT_NUM, y = Value, color = factor(SURVIVAL_FLAG))) +
    geom_line(size = 1) +
    geom_point(size = 2, alpha = 0.7) +
    scale_color_manual(values = c("0" = color_palette[4], "1" = color_palette[14])) +
    labs(
      title = paste("Mean of", variable, "by Visit Number and Survival Flag"),
      x = "Visit Number",
      y = "Mean Value",
      color = "Survival Flag"
    ) +
    theme_minimal() +
    theme(legend.position = "top")
  
  # Print the plot
  print(plot)
}
```


```{r Death Status by Laboratory Data (Blood) Blood Gas }

# Assuming `labs_blood_gas_death_outcome` contains numeric data and non-numeric columns to be excluded
correlation_data <- labs_blood_gas_death_outcome %>%
  select(where(is.numeric))

# Compute the correlation matrix
correlation_matrix <- cor(correlation_data, use = "pairwise.complete.obs", method = "pearson")

# Visualize the correlation matrix
library(corrplot)

# Plot the correlation matrix
corrplot(correlation_matrix, 
         method = "color", 
         type = "upper", 
         tl.col = "black", 
         tl.srt = 45, 
         number.cex = 0.3,    # Smaller text size for numbers
         addCoef.col = "black", 
         mar = c(1, 1, 1, 1),
         cl.cex = 0.8,        
         tl.cex = 0.3)   

# Extract correlation values with SURVIVAL_FLAG
correlated_vars <- correlation_matrix["SURVIVAL_FLAG", ]

# Select variables with absolute correlation > 0.2 (example threshold)
significant_vars <- names(correlated_vars[abs(correlated_vars) > 0.195])

# Print the selected variables
print(significant_vars)

# Define predictors to evaluate
predictors <- c("LACTATE", "REQUIRED O2")

# Prepare a list to store ROC results
roc_results <- list()

# Calculate ROC for each predictor and store results
for (predictor in predictors) {
  roc_obj <- roc(
    labs_blood_gas_death_outcome$SURVIVAL_FLAG,
    labs_blood_gas_death_outcome[[predictor]],
    plot = FALSE
  )
  roc_results[[predictor]] <- roc_obj
}

# Extract data for ggplot
roc_data <- do.call(rbind, lapply(names(roc_results), function(predictor) {
  roc_curve <- roc_results[[predictor]]
  data.frame(
    Sensitivity = roc_curve$sensitivities,
    Specificity = roc_curve$specificities,
    Predictor = predictor
  )
}))

# Combine AUC values for annotation
auc_values <- sapply(roc_results, function(x) auc(x))
auc_annotation <- paste(names(auc_values), round(auc_values, 2), sep = ": ", collapse = ", ")

# Plot ROC curves
roc_plot <- ggplot(roc_data, aes(x = 1 - Specificity, y = Sensitivity, color = Predictor)) +
  geom_line(size = 1.2) +
  labs(
    title = "ROC Curves for Selected Predictors",
    x = "1 - Specificity",
    y = "Sensitivity",
    color = "Predictor"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom") +
  annotate("text", x = 0.7, y = 0.3, label = paste("AUC Values:\n", auc_annotation), hjust = 0.5, size= 2.7)

# Print the plot
print(roc_plot)
```

"ALVEOLAR-ARTERIAL GRADIENT", "REQUIRED O2" predictors has correlation equal to 1, so we can use only one of them ("REQUIRED O2" was chosen).

ROC-curve for "LACTATE" and "REQUIRED O2" predictors 

An AUC in the range 0.6-0.7: Moderate discrimination ability.

#### 7.3.1.2. Hematology


#### 7.3.1.3. Blood Chemistry

### 7.3.2. Outcome 1: Death Status by Laboratory Data (Blood)
#### 7.3.2.1. Blood Gas

#### 7.3.2.2. Hematology


#### 7.3.2.3. Blood Chemistry

### 7.3.3. Outcome 1: Death Status by Laboratory Data (Blood)
#### 7.3.3.1. Blood Gas

#### 7.3.3.2. Hematology


#### 7.3.3.3. Blood Chemistry

# 8. Procedures Data
# 8.1. Read data

``` {r read data pocedures}
procedures <- read.csv("../data/raw/cleaned/PROCEDURES_clean.csv", stringsAsFactors = TRUE) %>%
  mutate(across(where(is.character), as.factor))  %>%
  filter(SUBJECT_ID %in% subject_ids_adults) %>%
  mutate(SUBJECT_ID = as.factor(SUBJECT_ID),
         ICUSTAY_ID = as.factor(ICUSTAY_ID))

skimr::skim(procedures %>%
              select(-SUBJECT_ID, -HADM_ID, -SUBJECT_ID_COMPOSE, -ICUSTAY_ID))
```


## 8.2. Desriptive Statistics

### 8.2.1. Descriptive Statistics for Numerical Variables (Procedures data)

```{r descriptive statistics for numerical vars procedures}
# Summarize the statistics for each numeric variable
procedures %>%
  select(SEQ_NUM) %>%
  select(where(is.numeric)) %>% 
  summarise(across(everything(), statistics)) %>%
  pivot_longer(cols = everything(), names_sep = "__", names_to = c("Variable", "Stat")) %>%
  rename(`Value` = value) %>%
  flextable() %>%
  merge_v("Variable") %>%
  width(j = c("Variable", "Stat", "Value"), width = 2) %>%
  autofit() %>%
  border_inner(border = fp_border(color = "black", width = 1)) %>%
  border_outer(border = fp_border(color = "black", width = 1))
```

### 8.2.2. Descriptive Statistics for Categorical Variables (Procedures data)

```{r Descriptive statistics for procedures for categorical vars}
# Clean and summarize the categorical data for all factor variables
procedures %>%
  select(LABEL, ORDERCATEGORYNAME) %>%
  select(where(is.factor)) %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "Value") %>%
  group_by(Variable, Value) %>%
  summarise(n = n(), .groups = 'drop') %>%
  group_by(Variable) %>%
  mutate(`No data` = sum(is.na(Value)),
         `% by group` = (n / sum(n)) * 100) %>%
  ungroup() %>%
  select(Variable, Value, n, `% by group`, `No data`) %>%
  arrange(Variable, desc(n)) %>%
  flextable() %>%
  merge_v("Variable") %>%
  autofit() %>%
  border_inner(border = fp_border(color = "black", width = 1)) %>%
  border_outer(border = fp_border(color = "black", width = 1))
```

Decided to focus on following procedures:

- CHEST X-RAY
- INVASIVE VENTILATION (min)
- EXTUBATION
- INTUBATION
- ARTERIAL LINE (min)
- MULTI LUMEN (min)
- DIALYSIS - CRRT (min)

## 8.3. Visualisation Analysis by Outcome
### 8.3.1. Outcome 1: Death Status by Procedures Data
#### 8.3.1.1. Procedures with duration

``` {r Outcome 1: Death Status by Procedures Data}

procedures_with_duration <- procedures %>%
  filter(LABEL %in% c("INVASIVE VENTILATION", 
                      "ARTERIAL LINE", 
                      "MULTI LUMEN", 
                      "DIALYSIS - CRRT")) %>%
  mutate(DURATION_MIN = as.numeric(VALUE)) %>%  # Ensure duration is numeric
  filter(!is.na(DURATION_MIN))  # Remove rows with missing durations

procedures_with_duration_death_outcome <- Death_status_outcome %>%
  left_join(procedures_with_duration, by = "SUBJECT_ID_COMPOSE") 

ggplot(procedures_with_duration_death_outcome, aes(x = LABEL, y = DURATION_MIN, fill = factor(SURVIVAL_FLAG))) +
  geom_boxplot(outlier.color = color_palette[4], outlier.size = 2) +
  labs(
    title = "Distribution of Duration (in Minutes) by Predictors and Survival Flag",
    x = "Predictor",
    y = "Duration (Minutes)",
    fill = "Survival Flag"
  ) +
  scale_fill_manual(
    values = sample(color_palette, size = length(unique(procedures_with_duration_death_outcome$SURVIVAL_FLAG)), replace = FALSE),
    labels = c("0" = "Survived", "1" = "Died")
    ) +
  scale_y_continuous(
    labels = scales::comma  # Format y-axis with commas for better readability
  ) +
  theme_custom +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

ggplot(procedures_with_duration_death_outcome, aes(x = DURATION_MIN, fill = factor(SURVIVAL_FLAG))) +
  geom_density(alpha = 0.6) +
  facet_wrap(~ LABEL, scales = "free") +  # Separate density plots for each predictor
  labs(
    title = "Density Plot of Duration (in Minutes) by Survival Flag",
    x = "Duration (Minutes)",
    y = "Density",
    fill = "Survival Flag"
  ) +
  scale_fill_manual(
    values = sample(color_palette, size = length(unique(procedures_with_duration_death_outcome$SURVIVAL_FLAG)), replace = FALSE),
    labels = c("0" = "Survived", "1" = "Died")
    ) +
  scale_x_continuous(
    labels = scales::comma  # Format y-axis with commas for better readability
  ) +
  theme_custom +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold")
  )

```

#### 8.3.1.2. Procedures without Duration

``` {r Death Status by Procedures Data Procedures without Duration}

procedures_binary <- procedures %>%
  filter(LABEL %in% c("CHEST X-RAY", "EXTUBATION", "INTUBATION")) %>%
  select(SUBJECT_ID_COMPOSE, LABEL, VALUE)

# Ensure all subjects have all required labels as columns
procedures_binary_death_outcome_flags <- Death_status_outcome %>%
  left_join(procedures_binary, by = "SUBJECT_ID_COMPOSE") %>%
  # Generate the required columns for each LABEL
  pivot_wider(
    names_from = LABEL,         # Create a column for each procedure (LABEL)
    values_from = LABEL,        # Use LABEL itself to check the condition
    values_fn = list(LABEL = ~ unique(.)), # Ensure one unique value per cell
    values_fill = NA            # Fill missing with NA for now
  ) %>%
  select(-VALUE, -`NA`) %>%
  # Replace NA with 0, otherwise set 1 in EXTUBATION, INTUBATION, and CHEST_X_RAY
  mutate(
    CHEST_X_RAY = if_else(is.na(`CHEST X-RAY`), 0, 1),
    EXTUBATION = if_else(is.na(EXTUBATION), 0, 1),
    INTUBATION = if_else(is.na(INTUBATION), 0, 1)
  ) %>%
  select(-`CHEST X-RAY`)
  
# Transform the data to long format for easier visualization
procedures_long <- procedures_binary_death_outcome_flags %>%
  pivot_longer(
    cols = c(CHEST_X_RAY, EXTUBATION, INTUBATION),  # Columns to reshape
    names_to = "Procedure",                        # New column for procedure names
    values_to = "Performed"                        # Binary flag: 0 or 1
  )

# Create a grouped bar plot
ggplot(procedures_long, aes(x = Procedure, fill = factor(Performed))) +
  geom_bar(position = "dodge", aes(y = ..count..), color = "black") +
  facet_wrap(~ SURVIVAL_FLAG, labeller = labeller(SURVIVAL_FLAG = c("0" = "Survived", "1" = "Died"))) +
  scale_fill_manual(
    values = c("0" = color_palette[3], "1" = color_palette[5]),
    labels = c("0" = "Not Performed", "1" = "Performed")
  ) +
  labs(
    title = "Distribution of Procedures by Survival Status",
    x = "Procedure",
    y = "Count",
    fill = "Performed"
  ) +
  theme_minimal() +
  theme(
    legend.position = "top",
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

```

### 8.3.2. Outcome 2: Length of Survival by Procedures Data
#### 8.3.2.1. Procedures with duration

```{r Length of Survival by Prescriptions Data Procedures with duration}
procedures_with_duration_survival_outcome <- Survival_outcome %>%
  left_join(procedures_with_duration, by = "SUBJECT_ID_COMPOSE")
  
ggplot(procedures_with_duration_survival_outcome, aes(x = LABEL, y = SURVIVAL, fill = LABEL)) +
  geom_boxplot(outlier.color = color_palette[8], outlier.size = 2, alpha = 0.6) +
  labs(
    title = "Distribution of Survival by Procedures with Duration",
    x = "Procedure",
    y = "Survival (Days)"
  ) +
  scale_fill_manual(values = sample(color_palette, size = length(unique(procedures_with_duration_survival_outcome$LABEL)), replace = FALSE)) +
  theme_custom +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(hjust = 0.5, face = "bold")
  )
  
```

#### 8.3.2.2. Procedures without Duration
```{r Length of Survival by Prescriptions Data Procedures without duration}

procedures_binary_survival_outcome_flags <- Survival_outcome %>%
  left_join(procedures_binary, by = "SUBJECT_ID_COMPOSE") %>%
  # Pivot the data to wide format, turning LABEL rows into columns
  pivot_wider(
    names_from = LABEL,         # Use LABEL as column names
    values_from = VALUE,        # Fill columns with VALUE (indicates performed or not)
    values_fn = list(LABEL = ~ unique(.)), # Ensure one unique value per cell
    values_fill = NA            # Fill missing with NA for now
  ) %>%
  select(-`NA`) %>%
  # Replace NA with 0, otherwise set 1 in EXTUBATION, INTUBATION, and CHEST_X_RAY
  mutate(
    CHEST_X_RAY = if_else((`CHEST X-RAY` == "NULL"), 0, 1),
    EXTUBATION = if_else((EXTUBATION == "NULL"), 0, 1),
    INTUBATION = if_else((INTUBATION == "NULL"), 0, 1)
  ) %>%
  select(-`CHEST X-RAY`, -SUBJECT_ID)

# Transform the data into long format for visualization
procedures_long <- procedures_binary_survival_outcome_flags %>%
  pivot_longer(
    cols = c(CHEST_X_RAY, EXTUBATION, INTUBATION),  # Procedures to include
    names_to = "Procedure",                        # Column for procedure names
    values_to = "Performed"                        # Binary flag (0 or 1)
  )

# Create a boxplot
ggplot(procedures_long, aes(x = factor(Performed), y = SURVIVAL, fill = Procedure)) +
  geom_boxplot(outlier.color = color_palette[5], outlier.shape = 16, outlier.size = 2) +
  facet_wrap(~ Procedure, scales = "free_x") +  # Separate plots for each procedure
  scale_fill_manual(values = sample(color_palette, size = length(unique(procedures_long$Procedure)))) +
  labs(
    title = "Survival (Days) Distribution by Procedure Performed",
    x = "Procedure Performed (0 = Not Performed, 1 = Performed)",
    y = "Survival (Days)",
    fill = "Procedure"
  ) +
  theme_minimal() +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )


```

### 8.4.3. Outcome 3: Length of ICU Stay by Procedures Data
#### 8.3.3.1. Procedures with duration
``` {r Length of ICU Stay by Procedures Data Procedures with duration}
procedures_with_duration_los_outcome <- LOS_outcome %>%
  left_join(procedures_with_duration, by = "SUBJECT_ID_COMPOSE")
  
ggplot(procedures_with_duration_los_outcome, aes(x = LABEL, y = LOS, fill = LABEL)) +
  geom_boxplot(outlier.color = color_palette[8], outlier.size = 2, alpha = 0.6) +
  labs(
    title = "Distribution of LOS by Procedures with Duration",
    x = "Procedure",
    y = "LOS (Days)"
  ) +
  scale_fill_manual(values = sample(color_palette, size = length(unique(procedures_with_duration_los_outcome$LABEL)), replace = FALSE)) +
  theme_custom +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(hjust = 0.5, face = "bold")
  )
```

#### 8.3.3.2. Procedures without Duration
``` {r Length of ICU Stay by Procedures Data Procedures without duration}

procedures_binary_los_outcome_flags <- LOS_outcome %>%
  left_join(procedures_binary, by = "SUBJECT_ID_COMPOSE") %>%
  # Pivot the data to wide format, turning LABEL rows into columns
  pivot_wider(
    names_from = LABEL,         # Use LABEL as column names
    values_from = VALUE,        # Fill columns with VALUE (indicates performed or not)
    values_fn = list(LABEL = ~ unique(.)), # Ensure one unique value per cell
    values_fill = NA            # Fill missing with NA for now
  ) %>%
  select(-`NA`) %>%
  # Replace NA with 0, otherwise set 1 in EXTUBATION, INTUBATION, and CHEST_X_RAY
  mutate(
    CHEST_X_RAY = if_else((`CHEST X-RAY` == "NULL"), 0, 1),
    EXTUBATION = if_else((EXTUBATION == "NULL"), 0, 1),
    INTUBATION = if_else((INTUBATION == "NULL"), 0, 1)
  ) %>%
  select(-`CHEST X-RAY`, -SUBJECT_ID)

# Transform the data into long format for visualization
procedures_long <- procedures_binary_los_outcome_flags %>%
  pivot_longer(
    cols = c(CHEST_X_RAY, EXTUBATION, INTUBATION),  # Procedures to include
    names_to = "Procedure",                        # Column for procedure names
    values_to = "Performed"                        # Binary flag (0 or 1)
  )

# Create a boxplot
ggplot(procedures_long, aes(x = factor(Performed), y = LOS, fill = Procedure)) +
  geom_boxplot(outlier.color = color_palette[20], outlier.shape = 16, outlier.size = 2) +
  facet_wrap(~ Procedure, scales = "free_x") +  # Separate plots for each procedure
  scale_fill_manual(values = sample(color_palette, size = length(unique(procedures_long$Procedure)))) +
  labs(
    title = "LOS (Days) Distribution by Procedure Performed",
    x = "Procedure Performed (0 = Not Performed, 1 = Performed)",
    y = "LOS (Days)",
    fill = "Procedure"
  ) +
  theme_minimal() +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

```

## 8.4. Exploratory analysis
### 8.4.1. Outcome 1: Death Status by Procedures Data

```{r Death Status by Procedures Data Exploratory Analysis}

# List of procedures to analyze
procedure_labels <- c("INVASIVE VENTILATION", "ARTERIAL LINE", "MULTI LUMEN", "DIALYSIS - CRRT")

# Perform statistical tests for each procedure
results_selected_procedures <- procedures_with_duration_death_outcome %>%
  filter(LABEL %in% procedure_labels) %>%  # Filter for specified procedures
  group_split(LABEL) %>%  # Split the data by LABEL
  map_df(~ {
    perform_statistical_tests(
      data = .x,
      dependent_var = "SURVIVAL_FLAG",
      independent_var = "VALUE",
      variable_name = unique(.x$LABEL)
    )
  })

# Check hypothesis for procedures without duration 
# List of procedures without duration
procedure_labels_binary <- c("CHEST_X_RAY", "EXTUBATION", "INTUBATION")

# Perform statistical tests for each procedure
results_procedures_without_duration <- procedures_binary_death_outcome_flags %>%
  pivot_longer(
    cols = all_of(procedure_labels_binary),  # Select relevant procedure columns
    names_to = "LABEL",                     # Create a new column for procedure names
    values_to = "Performed"                 # Binary flag: 0 or 1
  ) %>%
  group_split(LABEL) %>%  # Split the data by LABEL
  map_df(~ {
    perform_statistical_tests(
      data = .x,
      dependent_var = "SURVIVAL_FLAG",
      independent_var = "Performed",
      variable_name = unique(.x$LABEL)
    )
  })

# Print the results
print(bind_rows(results_procedures_without_duration,results_selected_procedures ))

# Clean up intermediate variables for procedures without duration
rm(procedure_labels_binary, procedures_binary_death_outcome_flags)

# Clean up all intermediate results
rm(results_selected_procedures, results_procedures_without_duration)

```

All analyzed procedures, including CHEST_X_RAY, EXTUBATION, INTUBATION, ARTERIAL LINE, DIALYSIS – CRRT, INVASIVE VENTILATION, and MULTI LUMEN, showed significant associations with survival outcomes based on the Mann-Whitney U Test (p < 0.05). This suggests that these procedures potentially influence survival probability and may serve as valuable predictors in future survival modeling. Including these variables in future models could enhance the accuracy of survival predictions, especially in critical care contexts

### 8.4.2. Outcome 2: Length of Survival by Procedures

```{r Length of Survival by Procedures Exploratory analysis}

# Generate Kaplan-Meier survival curve by number of drugs
fit_procedures_X_RAY <- survfit(Surv(SURVIVAL, SURVIVAL_FLAG) ~ CHEST_X_RAY, data = procedures_binary_survival_outcome_flags)

# Plot the Kaplan-Meier curve
ggsurvplot(
  fit_procedures_X_RAY,
  data = procedures_binary_survival_outcome_flags,
  pval = TRUE,  # Display p-value for drug number
  conf.int = TRUE,  # Add confidence intervals
  ggtheme = theme_custom,
  surv.median.line = "hv",
  legend.title = "CHEST_X_RAY",
  title = "Survival Curve by CHEST_X_RAY",
  palette = color_palette
)

fit_procedures_EXTUBATION <- survfit(Surv(SURVIVAL, SURVIVAL_FLAG) ~ EXTUBATION, data = procedures_binary_survival_outcome_flags)

# Plot the Kaplan-Meier curve
ggsurvplot(
  fit_procedures_EXTUBATION,
  data = procedures_binary_survival_outcome_flags,
  pval = TRUE,  # Display p-value for drug number
  conf.int = TRUE,  # Add confidence intervals
  ggtheme = theme_custom,
  surv.median.line = "hv",
  legend.title = "Extubation",
  title = "Survival Curve by Extubation",
  palette = color_palette
)

fit_procedures_INTUBATION <- survfit(Surv(SURVIVAL, SURVIVAL_FLAG) ~ INTUBATION, data = procedures_binary_survival_outcome_flags)

# Plot the Kaplan-Meier curve
ggsurvplot(
  fit_procedures_INTUBATION,
  data = procedures_binary_survival_outcome_flags,
  pval = TRUE,  # Display p-value for drug number
  conf.int = TRUE,  # Add confidence intervals
  ggtheme = theme_custom,
  surv.median.line = "hv",
  legend.title = "Intubation",
  title = "Survival Curve by Intubation",
  palette = color_palette
)

# Perform Hazard Ratio (HR) assessment
hr_table_X_RAY <- HR_assessment("SURVIVAL", "SURVIVAL_FLAG", "CHEST_X_RAY", procedures_binary_survival_outcome_flags)

hr_table_EXTUBATION <- HR_assessment("SURVIVAL", "SURVIVAL_FLAG", "EXTUBATION", procedures_binary_survival_outcome_flags)

hr_table_INTUBATION <- HR_assessment("SURVIVAL", "SURVIVAL_FLAG", "INTUBATION", procedures_binary_survival_outcome_flags)

# Filter and analyze procedures with duration
km_results_procedures <- procedures_with_duration_survival_outcome %>%
  filter(LABEL %in% procedure_labels) %>%  # Filter for specific procedures
  group_split(LABEL) %>%  # Split the data by LABEL
  map(~ {
    # Handle cases with insufficient or constant values
    if (n_distinct(.x$VALUE, na.rm = TRUE) > 3) {
      .x <- .x %>%
        mutate(Quartile = cut(
          VALUE,
          breaks = quantile(.x$VALUE, probs = 0:4/4, na.rm = TRUE),
          include.lowest = TRUE,
          labels = c("Q1", "Q2", "Q3", "Q4")  # Label quartiles
        ))
      
      fit <- survfit(Surv(SURVIVAL, SURVIVAL_FLAG) ~ Quartile, data = .x)
      
      # Create the Kaplan-Meier plot
      ggsurvplot(
        fit,
        data = .x,
        pval = TRUE,
        conf.int = TRUE,
        title = paste("Kaplan-Meier Survival Curve for", unique(.x$LABEL)),
        legend.title = "Quartiles",
        xlab = "Survival (Days)",
        ylab = "Survival Probability",
        palette = color_palette
      )
    } else {
      message(paste("Skipping", unique(.x$LABEL), "due to insufficient unique values"))
      NULL
    }
  })

# Filter out NULL results (cases with insufficient unique values)
km_results_procedures <- km_results_procedures[!sapply(km_results_procedures, is.null)]

# Print all Kaplan-Meier plots
for (plot in km_results_procedures) {
  print(plot)
}

# Divide procedure durations into quintiles and perform HR assessment
hr_results_procedures_with_quintiles <- procedures_with_duration_survival_outcome %>%
  filter(LABEL %in% procedure_labels) %>%  # Filter for specified procedures
  group_split(LABEL) %>%  # Split the data by LABEL
  map_df(~ {
    # Add quintiles for VALUE (duration)
    .x <- .x %>%
      mutate(
        Quintile = cut(
          VALUE,
          breaks = quantile(VALUE, probs = seq(0, 1, 0.2), na.rm = TRUE),
          include.lowest = TRUE,
          paste(c("Q1", "Q2", "Q3", "Q4", "Q5"), unique(.x$LABEL), sep = " _ ")
        )
      )
    
    # Perform HR assessment using the Quintile variable
    HR_assessment(
      survival_time = "SURVIVAL",
      event_status = "SURVIVAL_FLAG",
      predictors = "Quintile",
      data = .x
    ) 
  })

# Print the combined HR results
print(bind_rows(hr_table_X_RAY, hr_table_EXTUBATION, hr_table_INTUBATION, hr_results_procedures_with_quintiles))

# Clean up Kaplan-Meier and Hazard Ratio variables
rm(fit_procedures_X_RAY, fit_procedures_EXTUBATION, fit_procedures_INTUBATION)
rm(hr_table_X_RAY, hr_table_EXTUBATION, hr_table_INTUBATION)
rm(km_results_procedures, hr_results_procedures_with_quintiles)

# Clean up intermediate datasets
rm(procedures_binary_survival_outcome_flags, procedures_with_duration_survival_outcome)

# Clean up lists of procedure labels
rm(procedure_labels, procedure_labels_binary)
```

All analyzed procedures should be included in predictive survival models, as their HRs provide valuable insights into patient severity and outcomes except DIALYSIS. Special attention should be given to procedures like INTUBATION and INVASIVE VENTILATION, which strongly correlate with higher risk, as they may serve as critical predictors of poor survival

### 8.4.3. Outcome 3: Length of ICU Stay by Procedures Data

``` {r Length of ICU Stay by Procedures Data Exploratory analysis }
# List of procedures without duration
procedure_labels_binary <- c("CHEST_X_RAY", "EXTUBATION", "INTUBATION")

results_procedures_without_duration_LOS <- procedures_binary_los_outcome_flags %>%
  pivot_longer(
    cols = all_of(procedure_labels_binary),  # Select relevant procedure columns
    names_to = "LABEL",                     # Create a new column for procedure names
    values_to = "Performed"                 # Binary flag: 0 or 1
  ) %>%
  group_split(LABEL) %>%  # Split the data by LABEL
  map_df(~ {
    # Extract the LABEL name for the current group
    label_name <- unique(.x$LABEL)
    
    # Perform LOS analysis
    analyze_predictor_LOS(
      data = .x,
      predictor = "Performed",
      LOS = "LOS",
      patient_id = "SUBJECT_ID_COMPOSE"
    ) %>%
    mutate(Procedure = label_name)  # Add the LABEL name to the results
  })

# List of procedures with duration
procedure_labels_duration <- c("INVASIVE VENTILATION", "ARTERIAL LINE", "MULTI LUMEN", "DIALYSIS - CRRT")

# Perform analysis for procedures with durations split by quintiles
results_procedures_with_duration_LOS <- procedures_with_duration_los_outcome %>%
  filter(LABEL %in% procedure_labels_duration) %>%  # Filter for specified procedures
  group_split(LABEL) %>%  # Split the data by LABEL
  map_df(~ {
    # Add quintiles for VALUE (duration)
    .x <- .x %>%
      mutate(
        Quintile = cut(
          VALUE,
          breaks = quantile(VALUE, probs = seq(0, 1, 0.2), na.rm = TRUE),
          include.lowest = TRUE,
          labels = c("Q1", "Q2", "Q3", "Q4", "Q5")
        )
      )
    
    # Perform LOS analysis using Quintile
    analyze_predictor_LOS(
      data = .x,
      predictor = "Quintile",
      LOS = "LOS",
      patient_id = "SUBJECT_ID_COMPOSE"
    )  %>%
    mutate(Procedure = unique(.x$LABEL))
  })

# Print the results
print(bind_rows(results_procedures_without_duration_LOS, results_procedures_with_duration_LOS))

# Cleanup for procedures with duration
rm(procedure_labels_duration, procedures_with_duration_los_outcome)

# Cleanup all intermediate results
rm(procedures, procedures_binary, procedures_binary_los_outcome_flags, procedures_long, procedures_with_duration, procedures_with_duration_death_outcome,  results_procedures_without_duration_LOS, results_procedures_with_duration_LOS)
```

From the analysis of the mixed-effects linear model on the Length of Stay (LOS) outcome, the procedures "CHEST_X_RAY," "EXTUBATION," "INTUBATION," "ARTERIAL LINE," "INVASIVE VENTILATION," and "MULTI LUMEN" all showed statistically significant associations, with p-values less than 0.05. This suggests that these procedures could have an influence on LOS and may be valuable to include in future predictive models. 

On the other hand, "DIALYSIS - CRRT" showed predominantly non-significant results, indicating that it may not be a strong predictor of LOS in the context of this analysis. Therefore, it might be less critical for inclusion in future modeling efforts.

# Result Table

```{r result table}

# Create the data frame with consistent and clear values for merging
data <- data.frame(
  Predictor = c(
    "Demographic, socio-economic, and health system factors", "Gender", "Age", 
    "Admission type", "Marital Status", "Insurance", "Religion", "Ethnicity",
    "Diagnoses", "Number of diagnoses", "Key Diagnose", "All Diagnoses", 
    "Isolations", "TELE", "RESP", "CDIFF", "MRSA", "VRE",
    "Prescriptions", "Number of prescriptions", "ATC", "Generic names",
    "Procedures", "CHEST_X_RAY", "EXTUBATION", "INTUBATION", "ARTERIAL LINE", "INVASIVE VENTILATION", "DIALYSIS - CRRT"
  ),
  Death_Status = c("", "+", "+", "+", "+", "+", "+", "+", "", "+", "+", "+", 
                   "", "+", "-", "+", "+", "+",
                   "", "+", "+", "+",
                   "", "+", "+", "+", "+", "+", "+"),
  Survival = c("", "+", "+", "+", "+", "+", "+", "+", "", "", "Not estimated", "Not estimated", 
               "", "+", "-", "+", "-", "+",
               "", "+", "Not estimated", "Not estimated",
               "", "+", "+", "+", "+", "+", "-"),
  LOS = c("", "-", "+", "+", "-", "+", "+", "-", "", "", "Not estimated", "Not estimated",
          "", "-", "-", "+", "+", "+",
          "", "+", "Not estimated", "Not estimated",
          "", "+", "+", "+", "+", "+", "-")
)

# Replace empty cells with NA for proper vertical merging
data$Death_Status[data$Death_Status == ""] <- NA

# Create the flextable
ft <- flextable(data)

# Apply merging and formatting
ft <- ft %>%
  set_header_labels(
    Predictor = "Predictor",
    Death_Status = "Death Status",
    Survival = "Survival",
    LOS = "Length of Stay (LOS)"
  ) %>%
  autofit() %>%  # Automatically fit the table
  theme_vanilla()  # Add a clean theme

# Add padding and alignment for better visuals
ft <- ft %>%
  padding(padding = 6, part = "all") %>%
  align(align = "center", part = "all") %>%
  align(j = 1, align = "left", part = "all")  # Left-align the Predictor column

# Display the flextable
ft

```
